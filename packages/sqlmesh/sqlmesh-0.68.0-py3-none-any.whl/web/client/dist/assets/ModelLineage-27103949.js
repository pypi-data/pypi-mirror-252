import{r as i,R as o,q as A,e as X,j as t,d as F,ag as G,b9 as de,ba as me,L as te,S as se,i as Y,m as $,t as ue,c as he}from"./index-e91144d1.js";import{d as pe,e as ne,s as ae,f as oe,P as ce,h as Z,u as q,E as R,i as ge,j as J,M as fe,R as we,k as Ne,l as xe,m as ye,n as K,o as Q,p as ee,q as ve,r as be,t as je,v as Ee,w as Ce}from"./context-ad1178a5.js";import{L as Me}from"./ListboxShow-8e9e0be7.js";import{S as Se}from"./SearchList-cf915c0c.js";import"./_commonjs-dynamic-modules-302442b1.js";import"./Input-8ef83902.js";import"./popover-29a3eb77.js";function ze(){return o.createElement("svg",{xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 32 32"},o.createElement("path",{d:"M32 18.133H18.133V32h-4.266V18.133H0v-4.266h13.867V0h4.266v13.867H32z"}))}function Le(){return o.createElement("svg",{xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 32 5"},o.createElement("path",{d:"M0 0h32v4.2H0z"}))}function ke(){return o.createElement("svg",{xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 32 30"},o.createElement("path",{d:"M3.692 4.63c0-.53.4-.938.939-.938h5.215V0H4.708C2.13 0 0 2.054 0 4.63v5.216h3.692V4.631zM27.354 0h-5.2v3.692h5.17c.53 0 .984.4.984.939v5.215H32V4.631A4.624 4.624 0 0027.354 0zm.954 24.83c0 .532-.4.94-.939.94h-5.215v3.768h5.215c2.577 0 4.631-2.13 4.631-4.707v-5.139h-3.692v5.139zm-23.677.94c-.531 0-.939-.4-.939-.94v-5.138H0v5.139c0 2.577 2.13 4.707 4.708 4.707h5.138V25.77H4.631z"}))}function Ie(){return o.createElement("svg",{xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 25 32"},o.createElement("path",{d:"M21.333 10.667H19.81V7.619C19.81 3.429 16.38 0 12.19 0 8 0 4.571 3.429 4.571 7.619v3.048H3.048A3.056 3.056 0 000 13.714v15.238A3.056 3.056 0 003.048 32h18.285a3.056 3.056 0 003.048-3.048V13.714a3.056 3.056 0 00-3.048-3.047zM12.19 24.533a3.056 3.056 0 01-3.047-3.047 3.056 3.056 0 013.047-3.048 3.056 3.056 0 013.048 3.048 3.056 3.056 0 01-3.048 3.047zm4.724-13.866H7.467V7.619c0-2.59 2.133-4.724 4.723-4.724 2.591 0 4.724 2.133 4.724 4.724v3.048z"}))}function He(){return o.createElement("svg",{xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 25 32"},o.createElement("path",{d:"M21.333 10.667H19.81V7.619C19.81 3.429 16.38 0 12.19 0c-4.114 1.828-1.37 2.133.305 2.438 1.676.305 4.42 2.59 4.42 5.181v3.048H3.047A3.056 3.056 0 000 13.714v15.238A3.056 3.056 0 003.048 32h18.285a3.056 3.056 0 003.048-3.048V13.714a3.056 3.056 0 00-3.048-3.047zM12.19 24.533a3.056 3.056 0 01-3.047-3.047 3.056 3.056 0 013.047-3.048 3.056 3.056 0 013.048 3.048 3.056 3.056 0 01-3.048 3.047z"}))}const V=({children:e,className:s,...m})=>o.createElement("button",{type:"button",className:Z(["react-flow__controls-button",s]),...m},e);V.displayName="ControlButton";const Be=e=>({isInteractive:e.nodesDraggable||e.nodesConnectable||e.elementsSelectable,minZoomReached:e.transform[2]<=e.minZoom,maxZoomReached:e.transform[2]>=e.maxZoom}),le=({style:e,showZoom:s=!0,showFitView:m=!0,showInteractive:g=!0,fitViewOptions:d,onZoomIn:l,onZoomOut:h,onFitView:f,onInteractiveChange:u,className:M,children:a,position:w="bottom-left"})=>{const p=pe(),[E,N]=i.useState(!1),{isInteractive:x,minZoomReached:C,maxZoomReached:r}=ne(Be,ae),{zoomIn:y,zoomOut:v,fitView:j}=oe();if(i.useEffect(()=>{N(!0)},[]),!E)return null;const I=()=>{y(),l==null||l()},S=()=>{v(),h==null||h()},z=()=>{j(d),f==null||f()},L=()=>{p.setState({nodesDraggable:!x,nodesConnectable:!x,elementsSelectable:!x}),u==null||u(!x)};return o.createElement(ce,{className:Z(["react-flow__controls",M]),position:w,style:e,"data-testid":"rf__controls"},s&&o.createElement(o.Fragment,null,o.createElement(V,{onClick:I,className:"react-flow__controls-zoomin",title:"zoom in","aria-label":"zoom in",disabled:r},o.createElement(ze,null)),o.createElement(V,{onClick:S,className:"react-flow__controls-zoomout",title:"zoom out","aria-label":"zoom out",disabled:C},o.createElement(Le,null))),m&&o.createElement(V,{className:"react-flow__controls-fitview",onClick:z,title:"fit view","aria-label":"fit view"},o.createElement(ke,null)),g&&o.createElement(V,{className:"react-flow__controls-interactive",onClick:L,title:"toggle interactivity","aria-label":"toggle interactivity"},x?o.createElement(He,null):o.createElement(Ie,null)),a)};le.displayName="Controls";var Ae=i.memo(le),k;(function(e){e.Lines="lines",e.Dots="dots",e.Cross="cross"})(k||(k={}));function Te({color:e,dimensions:s,lineWidth:m}){return o.createElement("path",{stroke:e,strokeWidth:m,d:`M${s[0]/2} 0 V${s[1]} M0 ${s[1]/2} H${s[0]}`})}function _e({color:e,radius:s}){return o.createElement("circle",{cx:s,cy:s,r:s,fill:e})}const Re={[k.Dots]:"#91919a",[k.Lines]:"#eee",[k.Cross]:"#e2e2e2"},We={[k.Dots]:1,[k.Lines]:1,[k.Cross]:6},De=e=>({transform:e.transform,patternId:`pattern-${e.rfId}`});function re({id:e,variant:s=k.Dots,gap:m=20,size:g,lineWidth:d=1,offset:l=2,color:h,style:f,className:u}){const M=i.useRef(null),{transform:a,patternId:w}=ne(De,ae),p=h||Re[s],E=g||We[s],N=s===k.Dots,x=s===k.Cross,C=Array.isArray(m)?m:[m,m],r=[C[0]*a[2]||1,C[1]*a[2]||1],y=E*a[2],v=x?[y,y]:r,j=N?[y/l,y/l]:[v[0]/l,v[1]/l];return o.createElement("svg",{className:Z(["react-flow__background",u]),style:{...f,position:"absolute",width:"100%",height:"100%",top:0,left:0},ref:M,"data-testid":"rf__background"},o.createElement("pattern",{id:w+e,x:a[0]%r[0],y:a[1]%r[1],width:r[0],height:r[1],patternUnits:"userSpaceOnUse",patternTransform:`translate(-${j[0]},-${j[1]})`},N?o.createElement(_e,{color:p,radius:y/l}):o.createElement(Te,{dimensions:v,color:p,lineWidth:d})),o.createElement("rect",{x:"0",y:"0",width:"100%",height:"100%",fill:`url(#${w+e})`}))}re.displayName="Background";var Oe=i.memo(re);const P={UNKNOWN:"UNKNOWN",STRUCT:"STRUCT"};function Ue({id:e,data:s,sourcePosition:m,targetPosition:g}){const{models:d,withColumns:l,handleClickModel:h,lineage:f={},selectedNodes:u,setSelectedNodes:M,mainNode:a,activeNodes:w,withConnected:p,connectedNodes:E,highlightedNodes:N}=q(),{columns:x}=i.useMemo(()=>{var D;const n=d.get(e),c=(n==null?void 0:n.columns)??[];return Object.keys(((D=f[e])==null?void 0:D.columns)??{}).forEach(O=>{const U=c.find(({name:ie})=>ie===O);A(U)&&c.push({name:O,type:P.UNKNOWN})}),c.forEach(O=>{let U=O.type??P.UNKNOWN;U.startsWith(P.STRUCT)&&(U=P.STRUCT),O.type=U}),{columns:c}},[e,d,f]),C=i.useMemo(()=>Object.values(N??{}).flat(),[N]),[r,y]=i.useState(!1),v=i.useCallback(n=>{n.stopPropagation(),h==null||h(e)},[h,e,s.isInteractive]),j=i.useCallback(n=>{n.stopPropagation(),!(C.includes(e)||a===e)&&M(c=>(c.has(e)?c.delete(e):c.add(e),new Set(c)))},[M,C]),I=Object.keys(N??{}).find(n=>N[n].includes(e)),S=N==null?void 0:N["*"],z=a!==e&&G(h),L=s.type===R.cte,H=s.type===R.external,T=s.type===R.seed,W=s.type===R.python,b=l&&X(x)||r,B=a===e||C.includes(e),_=u.size>0||w.size>0||p?u.has(e)||w.has(e)||p&&E.has(e):E.has(e);return t.jsxs("div",{onMouseEnter:()=>y(!0),onMouseLeave:()=>y(!1),className:F("text-xs font-semibold rounded-lg shadow-lg relative z-1",L?"text-neutral-100":"text-secondary-500 dark:text-primary-100",(H||T)&&"border-4 border-accent-500 ring-8 ring-accent-200",u.has(e)&&"border-4 border-secondary-500 ring-8 ring-secondary-200",B&&"ring-8 ring-brand-200",A(I)?S:I,_||B?"opacity-100":"opacity-40 hover:opacity-100"),style:{maxWidth:A(s.width)?"auto":`${s.width}px`},children:[t.jsx(ge,{id:e,type:s.type,label:s.label,isSelected:u.has(e),isDraggable:!0,className:F(b?"rounded-t-md":"rounded-lg",L?"bg-accent-500":B?"bg-brand-500 text-brand-100 font-black":"bg-secondary-100 dark:bg-primary-900"),hasLeft:g===J.Left,hasRight:m===J.Right,handleClick:z?v:void 0,handleSelect:a===e||L||C.includes(e)?void 0:j,count:x.length}),b&&X(x)&&t.jsxs(t.Fragment,{children:[t.jsx(fe,{className:"max-h-[15rem]",nodeId:e,columns:x,disabled:W,withHandles:!0,withSource:!0,withDescription:!1}),t.jsx("div",{className:F("rounded-b-md py-1",L?"bg-accent-500":B?"bg-brand-500":"bg-secondary-100 dark:bg-primary-900")})]})]})}const Ve=30;function Je({model:e,highlightedNodes:s}){const{setActiveEdges:m,setConnections:g,setLineage:d,handleError:l,setSelectedNodes:h,setMainNode:f,setWithColumns:u,setHighlightedNodes:M,setNodeConnections:a}=q(),{refetch:w,isFetching:p,cancel:E}=de(e.name),[N,x]=i.useState(!1);i.useEffect(()=>{const r=me();return r.addEventListener("message",C),w().then(({data:y})=>{if(A(y))return;const v=Object.keys(y).length;u(v<=Ve),r.postMessage({topic:"lineage",payload:{currentLineage:{},newLineage:y,mainNode:e.fqn}}),x(!0)}).catch(y=>{l==null||l(y)}).finally(()=>{m(new Map),g(new Map),h(new Set),f(e.fqn)}),()=>{E==null||E(),r.removeEventListener("message",C),r.terminate(),d({}),a({}),f(void 0),M({}),u(!1)}},[e]),i.useEffect(()=>{M(s??{})},[s]);function C(r){r.data.topic==="lineage"&&(d(r.data.payload.lineage),a(r.data.payload.nodesConnections),x(!1)),r.data.topic==="error"&&(l==null||l(r.data.error),x(!1))}return t.jsxs("div",{className:"relative h-full w-full",children:[(p||N)&&t.jsx("div",{className:"absolute top-0 left-0 z-10 w-full h-full bg-theme flex justify-center items-center",children:t.jsxs(te,{className:"inline-block",children:[t.jsx(se,{className:"w-3 h-3 border border-neutral-10 mr-4"}),t.jsx("h3",{className:"text-md",children:p?"Loading Model's Lineage...":"Merging Model's..."})]})}),t.jsx(we,{children:t.jsx($e,{})})]})}function $e(){const{withColumns:e,models:s,lineage:m,mainNode:g,selectedEdges:d,selectedNodes:l,withConnected:h,withImpacted:f,withSecondary:u,hasBackground:M,activeEdges:a,connectedNodes:w,connections:p,handleError:E,setActiveNodes:N}=q(),{setCenter:x}=oe(),[C,r]=i.useState(!1),y=i.useMemo(()=>({model:Ue}),[]),v=i.useMemo(()=>Ne({lineage:m,models:s,withColumns:e}),[m,s,e]),j=i.useMemo(()=>xe(m),[m]),I=i.useMemo(()=>ye(m),[m]),[S,z]=i.useState([]),[L,H]=i.useState([]);i.useEffect(()=>{if(Y(j)||A(g))return;r(!0);const b=K(j,a,d,v),B=Q(Object.values(v),b,g,w,l,p,h,f,u,e),_=ee(j,p,a,b,d,l,w,h,f,u),n=ve({nodesMap:v,nodes:B,edges:_});return n.create().then(c=>{H(c.edges),z(c.nodes)}).catch(c=>{E==null||E(c),H([]),z([])}).finally(()=>{const c=A(g)?void 0:v[g];G(c)&&(x(c.position.x,c.position.y,{zoom:.5,duration:0}),setTimeout(()=>{r(!1)},100)),N(b)}),()=>{n.terminate(),H([]),z([])}},[I,e]),i.useEffect(()=>{const b=K(j,a,d,v);N(b)},[v,a,d]),i.useEffect(()=>{if(A(g)||Y(S))return;const b=K(j,a,d,v),B=Q(S,b,g,w,l,p,h,f,u,e),_=ee(j,p,a,b,d,l,w,h,f,u);H(_),z(B),N(b)},[p,v,j,a,l,d,w,h,f,u,e,g]);function T(b){z(Ee(b,S))}function W(b){H(Ce(b,L))}return t.jsxs(t.Fragment,{children:[C&&t.jsx("div",{className:"absolute top-0 left-0 z-10 bg-theme flex justify-center items-center w-full h-full",children:t.jsxs(te,{className:"inline-block",children:[t.jsx(se,{className:"w-3 h-3 border border-neutral-10 mr-4"}),t.jsx("h3",{className:"text-md",children:"Building Lineage..."})]})}),t.jsxs(be,{nodes:S,edges:L,nodeTypes:y,onNodesChange:T,onEdgesChange:W,nodeOrigin:[.5,.5],minZoom:.05,maxZoom:1.5,snapGrid:[16,16],snapToGrid:!0,children:[t.jsx(ce,{position:"top-right",className:"bg-theme !m-0 w-full",children:t.jsx(Pe,{nodes:S})}),t.jsx(Ae,{className:"bg-light p-1 rounded-md !border-none !shadow-lg"}),t.jsx(Oe,{variant:k.Dots,gap:32,size:4,className:F(M?"opacity-100":"opacity-0")})]})]})}function Pe({nodes:e=[]}){const{models:s,withColumns:m,lineage:g,mainNode:d,selectedNodes:l,withConnected:h,withImpacted:f,withSecondary:u,hasBackground:M,activeNodes:a,connectedNodes:w,highlightedNodes:p,setSelectedNodes:E,setWithColumns:N,setWithConnected:x,setWithImpacted:C,setWithSecondary:r,setHasBackground:y}=q(),v=i.useMemo(()=>{if(A(d)||A(g))return[];const n=je(g,d);return Object.keys(g).map(c=>{var D;return{name:c,displayName:((D=s.get(c))==null?void 0:D.displayName)??decodeURI(c),description:`${n.includes(c)?"Upstream":"Downstream"} | ${w.has(c)?"Directly":"Indirectly"} Connected`}}).filter(Boolean)},[g,d]),j=A(d)?void 0:s.get(d),I=l.size,S=w.size-1,z=e.filter(n=>$(w.has(n.id))).length,L=a.size>0?a.size:w.size,H=e.filter(n=>n.hidden).length,T=e.filter(n=>$(n.hidden)).length,W=e.filter(n=>$(n.hidden)&&(n.data.type===R.external||n.data.type===R.seed)).length,b=e.filter(n=>$(n.hidden)&&n.data.type===R.cte).length,B=i.useMemo(()=>Object.values(p??{}).flat(),[p]);function _(n){B.includes(n.name)||d===n.name||E(c=>(c.has(n.name)?c.delete(n.name):c.add(n.name),new Set(c)))}return t.jsxs("div",{className:"pl-2 flex items-center text-xs text-neutral-400",children:[t.jsxs("div",{className:"contents",children:[G(j)&&t.jsxs("span",{title:j.displayName,className:"mr-2 w-full min-w-[10rem] whitespace-nowrap text-ellipsis overflow-hidden",children:[t.jsx("b",{children:"Model:"})," ",ue(j.displayName,50,25)]}),G(p)??t.jsxs("span",{className:"mr-2 whitespace-nowrap",children:[t.jsx("b",{children:"Highlighted:"})," ",Object.keys(p??{}).length]}),I>0&&t.jsxs("span",{className:"mr-2 whitespace-nowrap",children:[t.jsx("b",{children:"Selected:"})," ",I]}),f&&I===0&&S>0&&t.jsxs("span",{className:"mr-2 whitespace-nowrap",children:[t.jsx("b",{children:"Impact:"})," ",S]}),u&&I===0&&z>0&&t.jsxs("span",{className:"mr-2 whitespace-nowrap",children:[t.jsx("b",{children:"Secondary:"})," ",z]}),t.jsxs("span",{className:"mr-2 whitespace-nowrap",children:[t.jsx("b",{children:"Active:"})," ",L]}),T>0&&T!==L&&t.jsxs("span",{className:"mr-2 whitespace-nowrap",children:[t.jsx("b",{children:"Visible:"})," ",T]}),H>0&&t.jsxs("span",{className:"mr-2 whitespace-nowrap",children:[t.jsx("b",{children:"Hidden:"})," ",H]}),W>0&&t.jsxs("span",{className:"mr-2 whitespace-nowrap",children:[t.jsx("b",{children:"Data Sources"}),": ",W]}),b>0&&t.jsxs("span",{className:"mr-2 whitespace-nowrap",children:[t.jsx("b",{children:"CTEs:"})," ",b]})]}),t.jsxs("div",{className:"flex w-full justify-end items-center",children:[t.jsx(Se,{list:v,placeholder:"Find",searchBy:"displayName",displayBy:"displayName",descriptionBy:"description",showIndex:!1,size:he.sm,onSelect:_,className:"w-full min-w-[15rem] max-w-[20rem]",isFullWidth:!0}),t.jsx(Me,{options:{Background:y,Columns:a.size>0&&l.size===0?void 0:N,Connected:a.size>0?void 0:x,Impact:a.size>0?void 0:C,Secondary:a.size>0?void 0:r},value:[m&&"Columns",M&&"Background",h&&"Connected",f&&"Impact",u&&"Secondary"].filter(Boolean)})]})]})}export{Je as default};
