import{r as i,R as s,q as T,aW as ue,e as he,j as t,d as q,ag as K,b9 as pe,ba as ge,L as ne,S as ae,i as J,m as F,t as fe,c as we}from"./index-f823a46d.js";import{d as Ne,e as oe,s as ce,f as le,P as re,h as X,u as Z,E as W,i as xe,j as Q,M as ye,R as ve,k as be,l as je,m as Ee,n as ee,o as te,p as se,q as Ce,r as Me,t as Se,v as ze,w as Le}from"./context-d40331ee.js";import{L as ke}from"./ListboxShow-966669dc.js";import{S as Ie}from"./SearchList-b6035f4b.js";import"./_commonjs-dynamic-modules-302442b1.js";import"./Input-7f1ddde5.js";import"./popover-cf930454.js";function He(){return s.createElement("svg",{xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 32 32"},s.createElement("path",{d:"M32 18.133H18.133V32h-4.266V18.133H0v-4.266h13.867V0h4.266v13.867H32z"}))}function Be(){return s.createElement("svg",{xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 32 5"},s.createElement("path",{d:"M0 0h32v4.2H0z"}))}function Te(){return s.createElement("svg",{xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 32 30"},s.createElement("path",{d:"M3.692 4.63c0-.53.4-.938.939-.938h5.215V0H4.708C2.13 0 0 2.054 0 4.63v5.216h3.692V4.631zM27.354 0h-5.2v3.692h5.17c.53 0 .984.4.984.939v5.215H32V4.631A4.624 4.624 0 0027.354 0zm.954 24.83c0 .532-.4.94-.939.94h-5.215v3.768h5.215c2.577 0 4.631-2.13 4.631-4.707v-5.139h-3.692v5.139zm-23.677.94c-.531 0-.939-.4-.939-.94v-5.138H0v5.139c0 2.577 2.13 4.707 4.708 4.707h5.138V25.77H4.631z"}))}function Ae(){return s.createElement("svg",{xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 25 32"},s.createElement("path",{d:"M21.333 10.667H19.81V7.619C19.81 3.429 16.38 0 12.19 0 8 0 4.571 3.429 4.571 7.619v3.048H3.048A3.056 3.056 0 000 13.714v15.238A3.056 3.056 0 003.048 32h18.285a3.056 3.056 0 003.048-3.048V13.714a3.056 3.056 0 00-3.048-3.047zM12.19 24.533a3.056 3.056 0 01-3.047-3.047 3.056 3.056 0 013.047-3.048 3.056 3.056 0 013.048 3.048 3.056 3.056 0 01-3.048 3.047zm4.724-13.866H7.467V7.619c0-2.59 2.133-4.724 4.723-4.724 2.591 0 4.724 2.133 4.724 4.724v3.048z"}))}function _e(){return s.createElement("svg",{xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 25 32"},s.createElement("path",{d:"M21.333 10.667H19.81V7.619C19.81 3.429 16.38 0 12.19 0c-4.114 1.828-1.37 2.133.305 2.438 1.676.305 4.42 2.59 4.42 5.181v3.048H3.047A3.056 3.056 0 000 13.714v15.238A3.056 3.056 0 003.048 32h18.285a3.056 3.056 0 003.048-3.048V13.714a3.056 3.056 0 00-3.048-3.047zM12.19 24.533a3.056 3.056 0 01-3.047-3.047 3.056 3.056 0 013.047-3.048 3.056 3.056 0 013.048 3.048 3.056 3.056 0 01-3.048 3.047z"}))}const $=({children:e,className:n,...d})=>s.createElement("button",{type:"button",className:X(["react-flow__controls-button",n]),...d},e);$.displayName="ControlButton";const De=e=>({isInteractive:e.nodesDraggable||e.nodesConnectable||e.elementsSelectable,minZoomReached:e.transform[2]<=e.minZoom,maxZoomReached:e.transform[2]>=e.maxZoom}),ie=({style:e,showZoom:n=!0,showFitView:d=!0,showInteractive:f=!0,fitViewOptions:a,onZoomIn:c,onZoomOut:y,onFitView:m,onInteractiveChange:w,className:M,children:l,position:h="bottom-left"})=>{const g=Ne(),[j,S]=i.useState(!1),{isInteractive:u,minZoomReached:E,maxZoomReached:o}=oe(De,ce),{zoomIn:N,zoomOut:x,fitView:b}=le();if(i.useEffect(()=>{S(!0)},[]),!j)return null;const H=()=>{N(),c==null||c()},L=()=>{x(),y==null||y()},z=()=>{b(a),m==null||m()},A=()=>{g.setState({nodesDraggable:!u,nodesConnectable:!u,elementsSelectable:!u}),w==null||w(!u)};return s.createElement(re,{className:X(["react-flow__controls",M]),position:h,style:e,"data-testid":"rf__controls"},n&&s.createElement(s.Fragment,null,s.createElement($,{onClick:H,className:"react-flow__controls-zoomin",title:"zoom in","aria-label":"zoom in",disabled:o},s.createElement(He,null)),s.createElement($,{onClick:L,className:"react-flow__controls-zoomout",title:"zoom out","aria-label":"zoom out",disabled:E},s.createElement(Be,null))),d&&s.createElement($,{className:"react-flow__controls-fitview",onClick:z,title:"fit view","aria-label":"fit view"},s.createElement(Te,null)),f&&s.createElement($,{className:"react-flow__controls-interactive",onClick:A,title:"toggle interactivity","aria-label":"toggle interactivity"},u?s.createElement(_e,null):s.createElement(Ae,null)),l)};ie.displayName="Controls";var Re=i.memo(ie),k;(function(e){e.Lines="lines",e.Dots="dots",e.Cross="cross"})(k||(k={}));function We({color:e,dimensions:n,lineWidth:d}){return s.createElement("path",{stroke:e,strokeWidth:d,d:`M${n[0]/2} 0 V${n[1]} M0 ${n[1]/2} H${n[0]}`})}function Oe({color:e,radius:n}){return s.createElement("circle",{cx:n,cy:n,r:n,fill:e})}const Ue={[k.Dots]:"#91919a",[k.Lines]:"#eee",[k.Cross]:"#e2e2e2"},Ve={[k.Dots]:1,[k.Lines]:1,[k.Cross]:6},$e=e=>({transform:e.transform,patternId:`pattern-${e.rfId}`});function de({id:e,variant:n=k.Dots,gap:d=20,size:f,lineWidth:a=1,offset:c=2,color:y,style:m,className:w}){const M=i.useRef(null),{transform:l,patternId:h}=oe($e,ce),g=y||Ue[n],j=f||Ve[n],S=n===k.Dots,u=n===k.Cross,E=Array.isArray(d)?d:[d,d],o=[E[0]*l[2]||1,E[1]*l[2]||1],N=j*l[2],x=u?[N,N]:o,b=S?[N/c,N/c]:[x[0]/c,x[1]/c];return s.createElement("svg",{className:X(["react-flow__background",w]),style:{...m,position:"absolute",width:"100%",height:"100%",top:0,left:0},ref:M,"data-testid":"rf__background"},s.createElement("pattern",{id:h+e,x:l[0]%o[0],y:l[1]%o[1],width:o[0],height:o[1],patternUnits:"userSpaceOnUse",patternTransform:`translate(-${b[0]},-${b[1]})`},S?s.createElement(Oe,{color:g,radius:N/c}):s.createElement(We,{dimensions:x,color:g,lineWidth:a})),s.createElement("rect",{x:"0",y:"0",width:"100%",height:"100%",fill:`url(#${h+e})`}))}de.displayName="Background";var Pe=i.memo(de);const G={UNKNOWN:"UNKNOWN",STRUCT:"STRUCT"};function Fe({id:e,data:n,sourcePosition:d,targetPosition:f}){const a=n??{},{connections:c,models:y,handleClickModel:m,lineage:w={},selectedNodes:M,setSelectedNodes:l,mainNode:h,activeNodes:g,withConnected:j,connectedNodes:S,highlightedNodes:u}=Z(),{columns:E}=i.useMemo(()=>{var Y;const I=y.get(e),_=(I==null?void 0:I.columns)??[];return Object.keys(((Y=w[e])==null?void 0:Y.columns)??{}).forEach(U=>{const V=_.find(({name:me})=>me===U);T(V)&&_.push({name:U,type:G.UNKNOWN})}),_.forEach(U=>{let V=U.type??G.UNKNOWN;V.startsWith(G.STRUCT)&&(V=G.STRUCT),U.type=V}),{columns:_}},[e,y,w]),o=i.useMemo(()=>Object.values(u??{}).flat(),[u]),[N,x]=i.useState(!1),b=i.useCallback(I=>{I.stopPropagation(),m==null||m(e)},[m,e,n.isInteractive]),H=i.useCallback(I=>{I.stopPropagation(),!(o.includes(e)||h===e)&&l(_=>(_.has(e)?_.delete(e):_.add(e),new Set(_)))},[l,o]),L=E.some(({name:I})=>c.get(ue(e,I))),z=Object.keys(u??{}).find(I=>u[I].includes(e)),A=u==null?void 0:u["*"],C=h===e||o.includes(e),B=M.has(e),O=h!==e&&K(m),v=a.type===W.cte,D=a.type===W.external,R=a.type===W.seed,r=a.type===W.python,p=(L||a.withColumns||N||B||C)&&he(E),P=M.size>0||g.size>0||j?B||g.has(e)||j&&S.has(e):S.has(e);return t.jsxs("div",{onMouseEnter:()=>x(!0),onMouseLeave:()=>x(!1),className:q("text-xs font-semibold rounded-lg shadow-lg relative z-1",v?"text-neutral-100":"text-secondary-500 dark:text-primary-100",(D||R)&&"border-4 border-accent-500 ring-8 ring-accent-200",B&&"border-4 border-secondary-500 ring-8 ring-secondary-200",C&&"ring-8 ring-brand-200",T(z)?A:z,P||C?"opacity-100":"opacity-40 hover:opacity-100"),style:{maxWidth:T(a.width)?"auto":`${a.width}px`},children:[t.jsx(xe,{id:e,type:a.type,label:a.label,isSelected:B,isDraggable:!0,className:q(p?"rounded-t-md":"rounded-lg",v?"bg-accent-500":C?"bg-brand-500 text-brand-100 font-black":"bg-secondary-100 dark:bg-primary-900"),hasLeft:f===Q.Left,hasRight:d===Q.Right,handleClick:O?b:void 0,handleSelect:h===e||v||o.includes(e)?void 0:H,count:E.length}),p&&t.jsxs(t.Fragment,{children:[t.jsx(ye,{className:"max-h-[15rem]",nodeId:e,columns:E,disabled:r,withHandles:!0,withSource:!0,withDescription:!1}),t.jsx("div",{className:q("rounded-b-md py-1",v?"bg-accent-500":C?"bg-brand-500":"bg-secondary-100 dark:bg-primary-900")})]})]})}const Ge=30;function st({model:e,highlightedNodes:n}){const{setActiveEdges:d,setConnections:f,setLineage:a,handleError:c,setSelectedNodes:y,setMainNode:m,setWithColumns:w,setHighlightedNodes:M,setNodeConnections:l}=Z(),{refetch:h,isFetching:g,cancel:j}=pe(e.name),[S,u]=i.useState(!1);i.useEffect(()=>{const o=ge();return o.addEventListener("message",E),h().then(({data:N})=>{if(T(N))return;const x=Object.keys(N).length;w(x<=Ge),o.postMessage({topic:"lineage",payload:{currentLineage:{},newLineage:N,mainNode:e.fqn}}),u(!0)}).catch(N=>{c==null||c(N)}).finally(()=>{d(new Map),f(new Map),y(new Set),m(e.fqn)}),()=>{j==null||j(),o.removeEventListener("message",E),o.terminate(),a({}),l({}),m(void 0),M({}),w(!1)}},[e]),i.useEffect(()=>{M(n??{})},[n]);function E(o){o.data.topic==="lineage"&&(a(o.data.payload.lineage),l(o.data.payload.nodesConnections),u(!1)),o.data.topic==="error"&&(c==null||c(o.data.error),u(!1))}return t.jsxs("div",{className:"relative h-full w-full",children:[(g||S)&&t.jsx("div",{className:"absolute top-0 left-0 z-10 w-full h-full bg-theme flex justify-center items-center",children:t.jsxs(ne,{className:"inline-block",children:[t.jsx(ae,{className:"w-3 h-3 border border-neutral-10 mr-4"}),t.jsx("h3",{className:"text-md",children:g?"Loading Model's Lineage...":"Merging Model's..."})]})}),t.jsx(ve,{children:t.jsx(qe,{})})]})}function qe(){const{withColumns:e,models:n,lineage:d,mainNode:f,selectedEdges:a,selectedNodes:c,withConnected:y,withImpacted:m,withSecondary:w,hasBackground:M,activeEdges:l,connectedNodes:h,connections:g,handleError:j,setActiveNodes:S}=Z(),{setCenter:u}=le(),[E,o]=i.useState(!1),N=i.useMemo(()=>({model:Fe}),[]),x=i.useMemo(()=>be({lineage:d,models:n,withColumns:e}),[d,n,e]),b=i.useMemo(()=>je(d),[d]),H=i.useMemo(()=>Ee(d),[d]),[L,z]=i.useState([]),[A,C]=i.useState([]);i.useEffect(()=>{if(J(b)||T(f))return;o(!0);const v=ee(b,l,a,x),D=te(Object.values(x),v,f,h,c,g,y,m,w),R=se(b,g,l,v,a,c,h,y,m,w),r=Ce({nodesMap:x,nodes:D,edges:R});return r.create().then(p=>{C(p.edges),z(p.nodes)}).catch(p=>{j==null||j(p),C([]),z([])}).finally(()=>{const p=T(f)?void 0:x[f];K(p)&&(u(p.position.x,p.position.y,{zoom:.5,duration:0}),setTimeout(()=>{o(!1)},100))}),()=>{r.terminate(),C([]),z([])}},[H,e]),i.useEffect(()=>{if(T(f)||J(L))return;const v=ee(b,l,a,x),D=te(L,v,f,h,c,g,y,m,w),R=se(b,g,l,v,a,c,h,y,m,w);C(R),z(D),S(v)},[g,x,b,l,c,a,h,y,m,w,e,f]);function B(v){z(ze(v,L))}function O(v){C(Le(v,A))}return t.jsxs(t.Fragment,{children:[E&&t.jsx("div",{className:"absolute top-0 left-0 z-10 bg-theme flex justify-center items-center w-full h-full",children:t.jsxs(ne,{className:"inline-block",children:[t.jsx(ae,{className:"w-3 h-3 border border-neutral-10 mr-4"}),t.jsx("h3",{className:"text-md",children:"Building Lineage..."})]})}),t.jsxs(Me,{nodes:L,edges:A,nodeTypes:N,onNodesChange:B,onEdgesChange:O,nodeOrigin:[.5,.5],minZoom:.05,maxZoom:1.5,snapGrid:[16,16],snapToGrid:!0,children:[t.jsx(re,{position:"top-right",className:"bg-theme !m-0 w-full",children:t.jsx(Ke,{nodes:L})}),t.jsx(Re,{className:"bg-light p-1 rounded-md !border-none !shadow-lg"}),t.jsx(Pe,{variant:k.Dots,gap:32,size:4,className:q(M?"opacity-100":"opacity-0")})]})]})}function Ke({nodes:e=[]}){const{models:n,withColumns:d,lineage:f,mainNode:a,selectedNodes:c,withConnected:y,withImpacted:m,withSecondary:w,hasBackground:M,activeNodes:l,connectedNodes:h,highlightedNodes:g,setSelectedNodes:j,setWithColumns:S,setWithConnected:u,setWithImpacted:E,setWithSecondary:o,setHasBackground:N}=Z(),x=i.useMemo(()=>{if(T(a)||T(f))return[];const r=Se(f,a);return Object.keys(f).map(p=>{var P;return{name:p,displayName:((P=n.get(p))==null?void 0:P.displayName)??decodeURI(p),description:`${r.includes(p)?"Upstream":"Downstream"} | ${h.has(p)?"Directly":"Indirectly"} Connected`}}).filter(Boolean)},[f,a]),b=T(a)?void 0:n.get(a),H=c.size,L=h.size-1,z=e.filter(r=>F(h.has(r.id))).length,A=l.size>0?l.size:h.size,C=e.filter(r=>r.hidden).length,B=e.filter(r=>F(r.hidden)).length,O=e.filter(r=>F(r.hidden)&&(r.data.type===W.external||r.data.type===W.seed)).length,v=e.filter(r=>F(r.hidden)&&r.data.type===W.cte).length,D=i.useMemo(()=>Object.values(g??{}).flat(),[g]);function R(r){D.includes(r.name)||a===r.name||j(p=>(p.has(r.name)?p.delete(r.name):p.add(r.name),new Set(p)))}return t.jsxs("div",{className:"pl-2 flex items-center text-xs text-neutral-400",children:[t.jsxs("div",{className:"contents",children:[K(b)&&t.jsxs("span",{title:b.displayName,className:"mr-2 w-full min-w-[10rem] whitespace-nowrap text-ellipsis overflow-hidden",children:[t.jsx("b",{children:"Model:"})," ",fe(b.displayName,50,25)]}),K(g)??t.jsxs("span",{className:"mr-2 whitespace-nowrap",children:[t.jsx("b",{children:"Highlighted:"})," ",Object.keys(g??{}).length]}),H>0&&t.jsxs("span",{className:"mr-2 whitespace-nowrap",children:[t.jsx("b",{children:"Selected:"})," ",H]}),m&&H===0&&L>0&&t.jsxs("span",{className:"mr-2 whitespace-nowrap",children:[t.jsx("b",{children:"Impact:"})," ",L]}),w&&H===0&&z>0&&t.jsxs("span",{className:"mr-2 whitespace-nowrap",children:[t.jsx("b",{children:"Secondary:"})," ",z]}),t.jsxs("span",{className:"mr-2 whitespace-nowrap",children:[t.jsx("b",{children:"Active:"})," ",A]}),B>0&&B!==A&&t.jsxs("span",{className:"mr-2 whitespace-nowrap",children:[t.jsx("b",{children:"Visible:"})," ",B]}),C>0&&t.jsxs("span",{className:"mr-2 whitespace-nowrap",children:[t.jsx("b",{children:"Hidden:"})," ",C]}),O>0&&t.jsxs("span",{className:"mr-2 whitespace-nowrap",children:[t.jsx("b",{children:"Data Sources"}),": ",O]}),v>0&&t.jsxs("span",{className:"mr-2 whitespace-nowrap",children:[t.jsx("b",{children:"CTEs:"})," ",v]})]}),t.jsxs("div",{className:"flex w-full justify-end items-center",children:[t.jsx(Ie,{list:x,placeholder:"Find",searchBy:"displayName",displayBy:"displayName",descriptionBy:"description",showIndex:!1,size:we.sm,onSelect:R,className:"w-full min-w-[15rem] max-w-[20rem]",isFullWidth:!0}),t.jsx(ke,{options:{Background:N,Columns:l.size>0&&c.size===0?void 0:S,Connected:l.size>0?void 0:u,Impact:l.size>0?void 0:E,Secondary:l.size>0?void 0:o},value:[d&&"Columns",M&&"Background",y&&"Connected",m&&"Impact",w&&"Secondary"].filter(Boolean)})]})]})}export{st as default};
