import{r as p,D as Ie,aa as Me,I as Le,y as ze,z as te,G as Ue,R as Z,ab as Ve,ac as $e,ad as Ge,X as Ee,ae as He,U as qe,Q as ke,j as e,a5 as ue,af as _e,a as J,a0 as j,m as B,a3 as S,c as k,ag as I,l as _,a8 as le,a2 as X,ah as G,ai as C,aj as Ke,d as f,ak as Ne,q as R,al as xe,am as Q,e as H,an as Se,a6 as re,n as he,b as je,ao as O,L as Fe,u as Oe,ap as We,aq as Ze,ar as Qe,S as Xe,E as Pe}from"./index-f823a46d.js";import{B as D}from"./Banner-662dedfb.js";import{R as Ye,p as Je}from"./ReportErrors-1ae8d36e.js";import{v as V,M as ge,P as ve}from"./disclosure-6b2379df.js";import{M as es,H as ss,u as W,a as be,b as P,E as y,P as M,c as as}from"./PlanChangePreview-19b3533b.js";import{I as q}from"./Input-7f1ddde5.js";import{s as ns}from"./popover-cf930454.js";import{T as ts,p as ls}from"./ListboxShow-966669dc.js";import"./_commonjs-dynamic-modules-302442b1.js";import"./context-d40331ee.js";import"./ModelLineage-9be79e23.js";import"./SearchList-b6035f4b.js";import"./PlusIcon-ceeaae3b.js";function rs({title:s,titleId:a,...n},t){return p.createElement("svg",Object.assign({xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 24 24",fill:"currentColor","aria-hidden":"true",ref:t,"aria-labelledby":a},n),s?p.createElement("title",{id:a},s):null,p.createElement("path",{fillRule:"evenodd",d:"M2.25 12c0-5.385 4.365-9.75 9.75-9.75s9.75 4.365 9.75 9.75-4.365 9.75-9.75 9.75S2.25 17.385 2.25 12zM12 8.25a.75.75 0 01.75.75v3.75a.75.75 0 01-1.5 0V9a.75.75 0 01.75-.75zm0 8.25a.75.75 0 100-1.5.75.75 0 000 1.5z",clipRule:"evenodd"}))}const is=p.forwardRef(rs),os=is;let ye=p.createContext(null);ye.displayName="GroupContext";let cs=p.Fragment;function ds(s){var a;let[n,t]=p.useState(null),[r,l]=ss(),[c,d]=He(),i=p.useMemo(()=>({switch:n,setSwitch:t,labelledby:r,describedby:c}),[n,t,r,c]),m={},x=s;return Z.createElement(d,{name:"Switch.Description"},Z.createElement(l,{name:"Switch.Label",props:{htmlFor:(a=i.switch)==null?void 0:a.id,onClick(o){n&&(o.currentTarget.tagName==="LABEL"&&o.preventDefault(),n.click(),n.focus({preventScroll:!0}))}}},Z.createElement(ye.Provider,{value:i},Ee({ourProps:m,theirProps:x,defaultTag:cs,name:"Switch.Group"}))))}let ms="button";function us(s,a){let n=Le(),{id:t=`headlessui-switch-${n}`,checked:r,defaultChecked:l=!1,onChange:c,name:d,value:i,form:m,...x}=s,o=p.useContext(ye),u=p.useRef(null),N=ze(u,a,o===null?null:o.setSwitch),[v,g]=ts(r,c,l),F=te(()=>g==null?void 0:g(!v)),A=te(E=>{if(qe(E.currentTarget))return E.preventDefault();E.preventDefault(),F()}),L=te(E=>{E.key===ke.Space?(E.preventDefault(),F()):E.key===ke.Enter&&ls(E.currentTarget)}),w=te(E=>E.preventDefault()),b=p.useMemo(()=>({checked:v}),[v]),$={id:t,ref:N,role:"switch",type:ns(s,u),tabIndex:0,"aria-checked":v,"aria-labelledby":o==null?void 0:o.labelledby,"aria-describedby":o==null?void 0:o.describedby,onClick:A,onKeyUp:L,onKeyPress:w},z=Ue();return p.useEffect(()=>{var E;let T=(E=u.current)==null?void 0:E.closest("form");T&&l!==void 0&&z.addEventListener(T,"reset",()=>{g(l)})},[u,g]),Z.createElement(Z.Fragment,null,d!=null&&v&&Z.createElement(Ve,{features:$e.Hidden,...Ge({as:"input",type:"checkbox",hidden:!0,readOnly:!0,form:m,checked:v,name:d,value:i})}),Ee({ourProps:$,theirProps:x,slot:b,defaultTag:ms,name:"Switch"}))}let ps=Ie(us),xs=ds,pe=Object.assign(ps,{Group:xs,Label:es,Description:Me});function hs({show:s,children:a,afterLeave:n,onClose:t=()=>{}}){return e.jsx(ue,{appear:!0,show:s,as:p.Fragment,afterLeave:n,children:e.jsxs(_e,{as:"div",className:"relative z-50 w-full h-full ",onClose:t,tabIndex:1,children:[e.jsx(ue.Child,{as:p.Fragment,enter:"ease-out duration-300",enterFrom:"bg-overlay opacity-0",enterTo:"bg-overlay opacity-80",leave:"ease-in duration-200",leaveFrom:"bg-overlay opacity-80",leaveTo:"bg-overlay opacity-0",children:e.jsx("div",{className:"fixed inset-0"})}),e.jsx("div",{className:"w-full h-full fixed inset-0",children:e.jsx(ue.Child,{as:p.Fragment,enter:"ease-out duration-300",enterFrom:"translate-x-[100%]",enterTo:"translate-x-0",leave:"ease-in duration-200",leaveFrom:"translate-x-0",leaveTo:"translate-x-[100%]",children:a})})]})})}function fs(){const s=J(n=>n.environment),a=j(n=>n.planApply);return e.jsxs("div",{className:"flex flex-col p-4 w-full",children:[e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsxs("h4",{className:"flex items-center text-xl pb-2 font-bold whitespace-nowrap",children:[e.jsx("span",{children:"Target Environment: "}),e.jsx("span",{className:"block ml-2 px-2 py-1 font-sm rounded-md bg-primary-10 text-primary-500",children:s.name})]}),e.jsx(Ye,{})]}),s.isInitialProd&&B(a.isFinished)&&e.jsx(D,{variant:S.Warning,children:e.jsx(V,{defaultOpen:!1,children:({open:n})=>e.jsxs(e.Fragment,{children:[e.jsxs(V.Button,{className:"w-full flex items-center justify-between",children:[e.jsx(D.Label,{className:"w-full",children:"Initializing Prod Environment"}),n?e.jsx(ge,{className:"w-5 text-warning-500"}):e.jsx(ve,{className:"w-5 text-warning-500"})]}),e.jsx(V.Panel,{className:"px-2 text-sm mt-2",children:e.jsx(D.Description,{children:"Prod will be completely backfilled in order to ensure there are no data gaps. After this is applied, it is recommended to validate further changes in a dev environment before deploying to production."})})]})})})]})}function js(s=0){return p.useCallback(a=>{setTimeout(()=>{a==null||a.focus()},s)},[s])}function gs(){const{start:s,end:a,skip_tests:n,skip_backfill:t,no_gaps:r,no_auto_categorization:l,forward_only:c,restate_models:d,include_unmodified:i,auto_apply:m,create_from:x}=W(),o=J(u=>u.environment);return e.jsx("div",{className:"text-xs px-4 py-2",children:e.jsx(D,{variant:S.Warning,size:k.sm,children:e.jsxs("p",{className:"text-sm",children:[e.jsx("span",{children:"Plan for"}),e.jsx("b",{className:"text-primary-500 font-bold mx-1",children:o.name}),e.jsx("span",{className:"inline-block mr-1",children:"environment"}),B(o.isProd)&&I(x)&&e.jsxs("span",{className:"inline-block mr-1",children:[e.jsx("span",{children:"based of"}),e.jsx("b",{className:"text-primary-500 font-bold mx-1",children:x})]}),_(m)&&e.jsxs("span",{className:"inline-block mr-1",children:["and ",e.jsx("b",{children:"Apply"})," automatically"]}),_(n)&&e.jsxs("span",{className:"inline-block mr-1",children:["without ",e.jsx("b",{children:"Tests"})]}),e.jsxs("span",{className:"inline-block mr-1",children:[e.jsx("span",{children:"from "}),e.jsx("b",{children:B(le(s))?s:"the begining of history"})]}),e.jsxs("span",{className:"inline-block mr-1",children:["till ",e.jsx("b",{children:B(le(s))?a:"today"})]}),_(r)&&e.jsxs("span",{className:"inline-block mr-1",children:["with ",e.jsx("b",{children:"No Gaps"})]}),_(t)&&e.jsxs("span",{className:"inline-block mr-1",children:["without ",e.jsx("b",{children:"Backfills"})]}),_(c)&&e.jsxs("span",{className:"inline-block mr-1",children:["all changes will be ",e.jsx("b",{children:"Forward Only"})]}),_(l)&&e.jsxs("span",{className:"inline-block mr-1",children:["also set ",e.jsx("b",{children:"Change Category"})," manually"]}),B(le(d))&&e.jsxs("span",{className:"inline-block mr-1",children:["and restate the following models ",e.jsx("b",{children:d})]}),_(i)&&e.jsx("span",{className:"inline-block mr-1",children:"and with views for all models in the target development environment"})]})})})}function vs({run:s,apply:a,cancel:n,reset:t,close:r,planAction:l}){const c=js();function d(u){u.stopPropagation(),r()}function i(u){u.stopPropagation(),t()}function m(u){u.stopPropagation(),n()}function x(u){u.stopPropagation(),a()}function o(u){u.stopPropagation(),s()}return e.jsxs(e.Fragment,{children:[B(l.isDone)&&e.jsx(gs,{}),e.jsxs("div",{className:"flex justify-between px-4 pb-2",children:[e.jsxs("div",{className:"flex w-full items-center",children:[(l.isRun||l.isRunning)&&e.jsx(X,{disabled:l.isRunning,onClick:o,ref:c,variant:S.Primary,autoFocus:!0,children:e.jsx("span",{children:G.getActionDisplayName(l,[C.RunningTask,C.Running,C.Run])})}),(l.isApply||l.isApplying)&&e.jsx(X,{onClick:x,disabled:l.isApplying,ref:c,variant:S.Primary,children:G.getActionDisplayName(l,[C.Applying,C.ApplyBackfill,C.ApplyVirtual,C.ApplyChangesAndBackfill,C.ApplyMetadata],"Apply")}),l.isProcessing&&e.jsx(X,{onClick:m,variant:S.Danger,className:"justify-self-end",disabled:l.isCancelling,children:G.getActionDisplayName(l,[C.Cancelling],"Cancel")})]}),e.jsxs("div",{className:"flex items-center",children:[[l.isProcessing,l.isRun].every(B)&&e.jsx(X,{onClick:i,variant:S.Neutral,disabled:Ke([C.Running,C.Applying,C.Cancelling],l.value),children:G.getActionDisplayName(l,[],"Start Over")}),e.jsx(X,{onClick:d,variant:l.isDone?S.Primary:S.Neutral,ref:l.isDone||l.isApplying?c:void 0,children:G.getActionDisplayName(l,[C.Done],"Close")})]})]})]})}function bs({label:s,enabled:a,setEnabled:n,a11yTitle:t,size:r=k.md,disabled:l=!1,className:c}){return e.jsxs(pe.Group,{as:"div",className:"flex items-center m-1",children:[e.jsxs(pe,{checked:l?!1:a,onChange:n,className:f("flex relative border-secondary-30 rounded-full m-0","shrink-0 focus:outline-none ring-secondary-300 ring-opacity-60 ring-offset ring-offset-secondary-100 focus:border-secondary-500 focus-visible:ring-opacity-75","transition duration-200 ease-in-out",a?"bg-secondary-500":"bg-secondary-20",c,l?"opacity-50 cursor-not-allowed":"cursor-pointer",r===k.sm&&"h-[14px] w-6 focus:ring-1 border",r===k.md&&"h-5 w-10 focus:ring-2 border-2",r===k.lg&&"h-7 w-14 focus:ring-4 border-2"),disabled:l,children:[e.jsx("span",{className:"sr-only",children:t}),e.jsx("span",{"aria-hidden":"true",className:f("pointer-events-none inline-block transform rounded-full shadow-md transition duration-200 ease-in-out","bg-light",r===k.sm&&"h-3 w-3",r===k.md&&"h-4 w-4",r===k.lg&&"h-6 w-6",a&&r===k.sm&&"translate-x-[10px]",a&&r===k.md&&"translate-x-5",a&&r===k.lg&&"translate-x-7")})]}),s!=null&&e.jsx(pe.Label,{className:f("text-xs font-light ml-1 text-neutral-600 dark:text-neutral-400"),children:s})]})}function K({label:s,info:a,enabled:n,disabled:t=!1,setEnabled:r,className:l}){return e.jsxs("div",{className:f("flex justify-between",l),children:[e.jsxs("label",{className:"block mb-1 px-3 text-sm font-bold",children:[s,e.jsx("small",{className:"block text-xs text-neutral-500",children:a})]}),e.jsx(bs,{disabled:t,enabled:n,setEnabled:r,size:k.lg})]})}function ys({disabled:s=!1,className:a}){const n=be(),{start:t,end:r,isInitialPlanRun:l}=W();return e.jsxs("div",{className:f("flex w-full flex-wrap md:flex-nowrap",a),children:[e.jsx(q,{className:"w-full md:w-[50%]",label:"Start Date (UTC)",info:"The start datetime of the interval",disabled:s||l,children:({disabled:c,className:d})=>e.jsx(q.Textfield,{className:f(d,"w-full"),disabled:c,placeholder:"2023-12-13",value:t,onInput:i=>{i.stopPropagation(),n({type:P.DateStart,start:i.target.value})}})}),e.jsx(q,{className:"w-full md:w-[50%]",label:"End Date (UTC)",info:"The end datetime of the interval",disabled:s||l,children:({disabled:c,className:d})=>e.jsx(q.Textfield,{className:f(d,"w-full"),disabled:c,placeholder:"2022-12-13",value:r,onInput:i=>{i.stopPropagation(),n({type:P.DateEnd,end:i.target.value})}})})]})}function ws(){const s=be(),{skip_tests:a,no_gaps:n,skip_backfill:t,forward_only:r,auto_apply:l,no_auto_categorization:c,restate_models:d,isInitialPlanRun:i,create_from:m,include_unmodified:x}=W(),o=p.useRef(null),u=j(w=>w.planAction),N=j(w=>w.planOverview),v=j(w=>w.planApply),g=J(w=>w.environment),F=J(w=>w.environments),A=Ne.getOnlyRemote(Array.from(F));p.useEffect(()=>{s({type:P.PlanOptions,...N.plan_options,skip_tests:!1})},[]);const L=u.isProcessing||u.isDone||v.isFinished||N.isLatest&&B(u.isRun);return p.useEffect(()=>{var w;R(o.current)||u.isProcessing&&o.current.classList.contains("--is-open")&&((w=o.current)==null||w.click())},[o,u]),e.jsxs("form",{className:"w-full",children:[e.jsx("fieldset",{className:f(L&&"opacity-50 cursor-not-allowed"),children:e.jsx(ys,{className:f(L&&"pointer-events-none")})}),e.jsx("fieldset",{className:"my-2",children:e.jsx(D,{children:e.jsx(V,{defaultOpen:!1,children:({open:w})=>e.jsxs(e.Fragment,{children:[e.jsxs(V.Button,{ref:o,className:f("w-full flex items-center",w&&"--is-open"),children:[e.jsxs(D.Label,{className:"mr-2 text-sm w-full",children:[e.jsx("span",{children:"Additional Options"}),L&&e.jsx("span",{className:"ml-1",children:"(Read Only)"})]}),w?e.jsx(ge,{className:"h-5 w-5 text-neutral-400"}):e.jsx(ve,{className:"h-5 w-5 text-neutral-400"})]}),e.jsxs(V.Panel,{unmount:!1,className:f("py-4 text-sm text-neutral-500",L&&"opacity-50 cursor-not-allowed"),children:[e.jsx("div",{className:f(L&&"pointer-events-none"),children:e.jsxs("div",{className:"flex flex-wrap md:flex-nowrap",children:[B(g.isProd)&&e.jsx(q,{className:"w-full",label:"Create From Environment",info:"The environment to base the plan on rather than local files",disabled:A.length<2,children:({className:b,disabled:$})=>e.jsx(q.Selector,{className:f(b,"w-full"),list:Ne.getOnlyRemote(Array.from(F)).filter(z=>z!==g).map(z=>({value:z.name,text:z.name})),onChange:z=>{s({type:P.PlanOptions,create_from:z})},value:m,disabled:$})}),e.jsx(q,{className:"w-full",label:"Restate Models",info:`Restate data for specified models and models
                    downstream from the one specified. For production
                    environment, all related model versions will have
                    their intervals wiped, but only the current
                    versions will be backfilled. For development
                    environment, only the current model versions will
                    be affected`,children:({className:b})=>e.jsx(q.Textfield,{className:f(b,"w-full"),placeholder:"project.model1, project.model2",disabled:i,value:d??"",onInput:$=>{$.stopPropagation(),s({type:P.PlanOptions,restate_models:$.target.value})}})})]})}),e.jsxs("div",{className:f("flex flex-wrap md:flex-nowrap w-full mt-3",L&&"pointer-events-none"),children:[e.jsxs("div",{className:"w-full md:mr-2",children:[e.jsx("div",{className:"block my-2",children:e.jsx(K,{label:"Skip Tests",info:`Skip tests prior to generating the plan if they
              are defined`,enabled:!!a,setEnabled:b=>{s({type:P.PlanOptions,skip_tests:b})}})}),e.jsx("div",{className:"block my-2",children:e.jsx(K,{label:"No Gaps",info:`Ensure that new snapshots have no data gaps when
              comparing to existing snapshots for matching
              models in the target environment`,enabled:!!n||!!t&&g.isInitialProd||g.isInitialProd,disabled:i||!!t&&g.isInitialProd||g.isInitialProd,setEnabled:b=>{s({type:P.PlanOptions,no_gaps:b})}})}),e.jsx("div",{className:"block my-2",children:e.jsx(K,{label:"Skip Backfill",info:"Skip the backfill step",enabled:!!t,disabled:i||g.isInitialProd,setEnabled:b=>{s({type:P.PlanOptions,skip_backfill:b})}})})]}),e.jsxs("div",{className:"w-full md:ml-2",children:[e.jsxs("div",{className:"block my-2",children:[e.jsx(K,{label:"Include Unmodified",info:"Indicates whether to create views for all models in the target development environment or only for modified ones",enabled:!!x,disabled:i||g.isInitialProd,setEnabled:b=>{s({type:P.PlanOptions,include_unmodified:b})}}),e.jsx(K,{label:"Forward Only",info:"Create a plan for forward-only changes",enabled:!!r,disabled:i||g.isInitialProd,setEnabled:b=>{s({type:P.PlanOptions,forward_only:b})}})]}),e.jsx("div",{className:"block my-2",children:e.jsx(K,{label:"Auto Apply",info:"Automatically apply the plan after it is generated",enabled:!!l,setEnabled:b=>{s({type:P.PlanOptions,auto_apply:b})}})}),e.jsx("div",{className:"block my-2",children:e.jsx(K,{label:"No Auto Categorization",info:"Set category manually",enabled:!!c,disabled:i||g.isInitialProd,setEnabled:b=>{s({type:P.PlanOptions,no_auto_categorization:b})}})})]})]})]})]})})})})]})}function ks({environment:s,isInitialPlanRun:a}){const{start:n,end:t,skip_tests:r,no_gaps:l,skip_backfill:c,forward_only:d,no_auto_categorization:i,restate_models:m,create_from:x,include_unmodified:o,auto_apply:u}=W(),N=p.useMemo(()=>{if(!s.isProd)return{start:n,end:a&&le(m)?void 0:t}},[s,n,t,a,m]);return{planOptions:p.useMemo(()=>s.isInitialProd?{include_unmodified:!0,no_gaps:!0,skip_tests:r,auto_apply:u}:{skip_tests:r,no_gaps:l,skip_backfill:c,forward_only:d,create_from:x,no_auto_categorization:i,restate_models:m,include_unmodified:o,auto_apply:u},[s,l,c,d,o,x,i,r,m,u]),planDates:N}}function Ns({isInitialPlanRun:s}){const{start:a,end:n,skip_tests:t,no_gaps:r,skip_backfill:l,forward_only:c,include_unmodified:d,no_auto_categorization:i,restate_models:m,create_from:x,change_categorization:o}=W(),u=p.useMemo(()=>{if(!s)return{start:a,end:n}},[a,n,s]),N=p.useMemo(()=>Array.from(o.values()).reduce((v,{category:g,change:F})=>(v[F.name]=(g==null?void 0:g.value)??xe.NUMBER_1,v),{}),[o]);return{planDates:u,planOptions:{no_gaps:r,skip_backfill:l,forward_only:c,include_unmodified:d,create_from:x,no_auto_categorization:i,skip_tests:t,restate_models:m},categories:N}}function Ps({title:s,titleId:a,...n},t){return p.createElement("svg",Object.assign({xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 20 20",fill:"currentColor","aria-hidden":"true",ref:t,"aria-labelledby":a},n),s?p.createElement("title",{id:a},s):null,p.createElement("path",{fillRule:"evenodd",d:"M16.704 4.153a.75.75 0 01.143 1.052l-8 10.5a.75.75 0 01-1.127.075l-4.5-4.5a.75.75 0 011.06-1.06l3.894 3.893 7.48-9.817a.75.75 0 011.05-.143z",clipRule:"evenodd"}))}const Ts=p.forwardRef(Ps),Y=Ts;function ne(s,a){const n=s.isFinished&&(a.isLatest||a.isRunning)&&I(s.overview),t=n?s.overview:a,r=n?s:a;return{meta:r.meta,start:r.start,end:r.end,hasChanges:t.hasChanges,hasBackfills:t.hasBackfills,backfills:r.backfills??[],added:r.added??[],removed:r.removed??[],direct:r.direct??[],indirect:r.indirect??[],metadata:r.metadata??[],plan_options:r.plan_options,stageValidation:r.stageValidation,stageBackfills:r.stageBackfills,stageChanges:r.stageChanges}}const Te=3;function ee({progress:s=0,delay:a=0,duration:n=0,startFromZero:t=!0,className:r}){return B(t)&&(s=s<Te?Te:s),e.jsx("div",{className:f("w-full h-1 bg-neutral-30 overflow-hidden flex items-center rounded-lg my-1",r),children:e.jsx("div",{className:"transition-[width] h-full bg-success-500 rounded-lg",style:{width:`${s}%`,transitionDelay:`${a}ms`,transitionDuration:`${n}ms`}})})}const h=function({children:a,setRefTasksOverview:n,tasks:t}){const{models:r,taskCompleted:l,taskTotal:c,batchesTotal:d,batchesCompleted:i}=p.useMemo(()=>{const m=Object.values(t),x=m.length;let o=0,u=0,N=0;return m.forEach(v=>{o=v.completed===v.total?o+1:o,u+=v.total,N+=v.completed}),{models:m,taskCompleted:o,taskTotal:x,batchesTotal:u,batchesCompleted:N}},[t]);return e.jsx("div",{className:"text-prose",ref:n,children:a({models:r,completed:l,total:c,totalBatches:d,completedBatches:i})})};function Cs({className:s,headline:a,environment:n,completed:t,total:r,updatedAt:l,updateType:c,completedBatches:d,totalBatches:i}){return e.jsx(we,{className:s,children:e.jsxs(ie,{children:[e.jsxs(oe,{children:[e.jsx(ce,{children:e.jsx(Be,{headline:a,environment:n})}),e.jsxs(de,{children:[e.jsx(se,{completed:t,total:r,unit:"task"}),e.jsx(ae,{}),e.jsx(se,{completed:d,total:i,unit:"batches"}),e.jsx(ae,{}),e.jsx(me,{completed:d,total:i})]})]}),e.jsx(ee,{progress:Q(d,i)}),I(l)&&e.jsx(Rs,{updatedAt:l,updateType:c})]})})}function Ds({models:s,className:a,added:n,removed:t,direct:r,indirect:l,metadata:c,showBatches:d=!0,showProgress:i=!0,showVirtualUpdate:m=!1,queue:x}){return e.jsxs(e.Fragment,{children:[H(x)&&e.jsxs("div",{className:"p-4 mt-6 shadow-lg rounded-lg",children:[e.jsx(Se,{text:"Currently in proccess"}),e.jsx(fe,{models:x,children:o=>e.jsxs(ie,{children:[e.jsxs(oe,{children:[e.jsxs(ce,{children:[H(o.interval)&&e.jsx(Ce,{start:o.interval[0],end:o.interval[1]}),e.jsx(Re,{modelName:o.displayViewName,changeType:Ae({modelName:o.name,added:n,removed:t,direct:r,indirect:l,metadata:c})})]}),e.jsxs(de,{children:[d&&e.jsx(se,{completed:o.completed,total:o.total,unit:"batch"}),e.jsx(ae,{}),i&&e.jsx(e.Fragment,{children:R(o.end)||R(o.start)?e.jsx(me,{total:o.total,completed:o.completed}):e.jsx(De,{start:o.start,end:o.end})}),m&&e.jsx("span",{className:"inline-block whitespace-nowrap font-bold ml-2",children:"Updated"})]})]}),i?e.jsx(ee,{startFromZero:!1,progress:Q(o.completed,o.total)}):e.jsx(re,{className:"my-1 border-neutral-200 opacity-50"})]})})]}),e.jsx(we,{className:a,children:e.jsx(fe,{models:s,children:o=>e.jsxs(ie,{children:[e.jsxs(oe,{children:[e.jsxs(ce,{children:[H(o.interval)&&e.jsx(Ce,{start:o.interval[0],end:o.interval[1]}),e.jsx(Re,{modelName:o.displayViewName,changeType:Ae({modelName:o.name,added:n,removed:t,direct:r,indirect:l,metadata:c})})]}),e.jsxs(de,{children:[d&&e.jsx(se,{completed:o.completed,total:o.total,unit:"batch"}),e.jsx(ae,{}),i&&e.jsx(e.Fragment,{children:R(o.end)||R(o.start)?e.jsx(me,{total:o.total,completed:o.completed}):e.jsx(De,{start:o.start,end:o.end})}),m&&e.jsx("span",{className:"inline-block whitespace-nowrap font-bold ml-2",children:"Updated"})]})]}),i?e.jsx(ee,{progress:Q(o.completed,o.total),startFromZero:x.findIndex(u=>u.name===o.name)===-1}):e.jsx(re,{className:"my-1 border-neutral-200 opacity-50"})]})})})]})}function we({className:s,children:a}){return e.jsx("div",{className:f("max-h-[50vh] overflow-auto hover:scrollbar scrollbar--vertical scrollbar--horizontal",s),children:a})}function ie({className:s,children:a}){return e.jsx("div",{className:f("px-2",s),children:a})}function fe({className:s,models:a,children:n}){return e.jsx("ul",{className:f("rounded-lg py-4 overflow-auto text-prose hover:scrollbar scrollbar--vertical scrollbar--horizontal",s),children:a.map(t=>e.jsx("li",{className:"mb-2",children:n(t)},t.name))})}function oe({className:s,children:a}){return e.jsx("div",{className:f("flex sm:justify-between sm:items-baseline text-xs",s),children:a})}function Be({className:s,headline:a,environment:n}){return e.jsxs("span",{className:f("flex items-center",s),children:[e.jsx("span",{className:"block whitespace-nowrap text-sm font-medium",children:a}),I(n)&&e.jsx("small",{className:"inline-block ml-1 px-2 py-[0.125rem] text-xs font-bold bg-neutral-10 rounded-md",children:n})]})}function ce({className:s,children:a}){return e.jsx("div",{className:f("flex mr-6 w-full sm:w-auto overflow-hidden",s),children:a})}function de({className:s,children:a}){return e.jsx("div",{className:f("flex items-center",s),children:a})}function Ce({className:s,start:a,end:n}){return e.jsxs("span",{className:f("inline-block mr-2 whitespace-nowrap font-mono",s),children:[a," – ",n]})}function se({className:s,total:a,completed:n,unit:t}){return e.jsxs("span",{className:f("inline-block whitespace-nowrap",s),children:[n," of ",a," ",Je(t,a)]})}function ae({className:s}){return e.jsx("span",{className:f("inline-block mx-2",s),children:"|"})}function me({className:s,total:a,completed:n}){return e.jsxs("span",{className:f("inline-block whitespace-nowrap font-bold",s),children:[Math.ceil(Q(n,a)),"%"]})}function De({className:s,start:a,end:n}){return e.jsx("span",{className:f("inline-block whitespace-nowrap font-bold",s),children:`${Math.floor((n-a)/6e4)}:${String(Math.ceil((n-a)/1e3%60)).padStart(2,"0")}`})}function Rs({updateType:s,updatedAt:a}){return e.jsxs("div",{className:"flex justify-between mt-1",children:[e.jsxs("small",{className:"text-xs",children:[e.jsx("b",{children:"Update Type:"}),e.jsx("span",{className:"inline-block ml-1",children:s})]}),e.jsxs("small",{className:"text-xs",children:[e.jsx("b",{children:"Last Update:"}),e.jsx("span",{className:"inline-block ml-1",children:he(new Date(a),"yyyy-mm-dd hh-mm-ss",!1)})]})]})}function Re({className:s,modelName:a,changeType:n}){return e.jsx("span",{className:f("font-bold whitespace-nowrap",n===y.Add&&"text-success-600  dark:text-success-500",n===y.Remove&&"text-danger-500",n===y.Direct&&"text-secondary-500 dark:text-primary-500",n===y.Indirect&&"text-warning-500",n===y.Default&&"text-prose",s),children:a})}h.Block=we;h.Summary=Cs;h.Details=Ds;h.DetailsProgress=de;h.Task=ie;h.Tasks=fe;h.TaskDetails=oe;h.TaskProgress=me;h.TaskSize=se;h.TaskDivider=ae;h.TaskInfo=ce;h.TaskHeadline=Be;function Ae({modelName:s,added:a,removed:n,direct:t,indirect:r,metadata:l}){return a.some(c=>c.name===s)?y.Add:n.some(c=>c.name===s)?y.Remove:t.some(c=>c.name===s)?y.Direct:r.some(c=>c.name===s)?y.Indirect:l.some(c=>c.name===s)?y.Metadata:y.Default}function As({report:s}){var a;return e.jsxs("div",{children:[e.jsxs("div",{className:"py-2",children:[e.jsxs("p",{children:["Total: ",s.total]}),e.jsxs("p",{children:["Succeeded: ",s.successful]}),e.jsxs("p",{children:["Failed: ",s.failures]}),e.jsxs("p",{children:["Errors: ",s.errors]}),e.jsxs("p",{children:["Dialect: ",s.dialect]})]}),e.jsx("ul",{children:(a=s.details)==null?void 0:a.map(n=>e.jsxs("li",{className:"flex mb-1",children:[e.jsx("span",{className:"inline-block mr-4",children:"—"}),e.jsxs("div",{className:"overflow-hidden",children:[e.jsx("span",{className:"inline-block mb-2",children:n.message}),e.jsx("code",{className:"inline-block max-h-[50vh] bg-theme py-2 px-4 rounded-lg w-full overflow-auto hover:scrollbar scrollbar--vertical scrollbar--horizontal",children:e.jsx("pre",{children:n.details})})]})]},n.message))})]})}function Es(){const s=je(m=>m.tests),a=j(m=>m.planApply),n=j(m=>m.planOverview),t=j(m=>m.planAction),{hasChanges:r,hasBackfills:l,plan_options:c}=ne(a,n),d=I(s)&&!!s.total,i=I(s)&&!!s.message&&B(d);return t.isRun?e.jsx(e.Fragment,{}):e.jsxs("div",{className:"mt-8 mb-4",children:[t.isRunning||_(r)?e.jsx(_s,{isOpen:!0}):e.jsxs(D,{className:"flex items-center mb-1",size:k.sm,hasBackground:!1,children:[e.jsx(Y,{className:"w-5 mr-2"}),e.jsx(D.Label,{className:"mr-2 text-sm",children:"No Changes"})]}),t.isRunning||_(l)?e.jsx(Ss,{isOpen:!0}):e.jsxs(D,{className:"flex items-center mb-1",size:k.sm,hasBackground:!1,children:[e.jsx(Y,{className:"w-5 mr-2"}),e.jsx(D.Label,{className:"mr-2 text-sm",children:"No Backfills"})]}),_(c==null?void 0:c.skip_tests)?e.jsxs(D,{className:"flex items-center mb-1",size:k.sm,hasBackground:!1,children:[e.jsx(Y,{className:"w-5 mr-2"}),e.jsx(D.Label,{className:"mr-2 text-sm",children:"Tests Skipped"})]}):e.jsxs(e.Fragment,{children:[i&&e.jsx(Fs,{report:s}),d&&e.jsx(Os,{isOpen:!0,report:s})]}),e.jsx(Bs,{}),e.jsx(Vs,{}),e.jsxs(Is,{start:a.evaluationStart,end:a.evaluationEnd,children:[e.jsx(Ms,{}),e.jsx(Ls,{}),e.jsx(zs,{}),e.jsx(Us,{})]})]})}function _s({isOpen:s=!1}){const a=j(l=>l.planApply),n=j(l=>l.planOverview),{meta:t,stageChanges:r}=ne(a,n);return e.jsx(U,{meta:(r==null?void 0:r.meta)??t??{status:O.init},states:["Changes","Failed Getting Changes","Getting Changes..."],isOpen:s,panel:e.jsx($s,{})})}function Ss({isOpen:s}){const a=j(c=>c.planApply),n=j(c=>c.planOverview),{meta:t,stageBackfills:r,backfills:l}=ne(a,n);return e.jsx(U,{meta:(r==null?void 0:r.meta)??t??{status:O.init},states:["Backfills","Failed Getting Backfills","Getting Backfills..."],isOpen:s,panel:e.jsx(M,{headline:`Models ${l.length}`,type:y.Default,children:e.jsx(M.Default,{type:y.Default,changes:l})})})}function Fs({report:s}){return e.jsx(U,{meta:{status:O.success,...s},states:["Tests Completed","Failed Tests","Running Tests..."],children:s.message})}function Os({report:s,isOpen:a=!1}){return e.jsx(U,{variant:S.Danger,meta:{status:O.fail,...s},isOpen:a,states:["Tests Failed","One or More Tests Failed","Running Tests..."],shouldCollapse:!1,children:e.jsx(As,{report:s})})}function Bs(){const s=j(t=>t.planApply),a=j(t=>t.planOverview),{stageValidation:n}=ne(s,a);return e.jsx(U,{meta:n==null?void 0:n.meta,states:["Plan Validated","Plan Validation Failed","Validating Plan..."],showDetails:!1})}function Is({start:s,end:a,children:n}){const t=je(d=>d.tests),r=j(d=>d.planApply),l=p.useRef(null),c=I(t)&&!!t.failures;return p.useEffect(()=>{requestAnimationFrame(()=>{var d;(d=l.current)==null||d.scrollIntoView({behavior:"smooth",block:"start"})})},[]),c||r.shouldShowEvaluation?e.jsxs("div",{ref:l,className:"pt-6 pb-2",children:[I(s)&&e.jsxs(e.Fragment,{children:[e.jsxs("small",{className:"text-neutral-500 block px-4 mb-1",children:["Evaluation started at"," ",e.jsx("b",{children:he(new Date(s),"yyyy-mm-dd hh-mm-ss")})]}),e.jsx(re,{}),e.jsx("small",{className:"text-neutral-500 block px-4 mt-1",children:"Given a plan, it pushes snapshots into the state and then kicks off the backfill process for all affected snapshots. Once backfill is done, snapshots that are part of the plan are promoted in the environment targeted by this plan."})]}),e.jsx("div",{className:"py-2",children:n}),I(a)&&e.jsxs(e.Fragment,{children:[e.jsx(re,{}),e.jsxs("small",{className:"text-neutral-500 block px-4 mt-1",children:["Evaluation stopped at"," ",e.jsx("b",{children:he(new Date(a),"yyyy-mm-dd hh-mm-ss")})]})]})]}):e.jsx(e.Fragment,{})}function Ms({isOpen:s}){var n;const a=j(t=>t.planApply);return R(a.stageCreation)?e.jsx(e.Fragment,{}):e.jsx(U,{meta:(n=a.stageCreation)==null?void 0:n.meta,states:["Snapshot Tables Created","Snapshot Tables Creation Failed","Creating Snapshot Tables..."],isOpen:s,children:e.jsx(h.Block,{children:e.jsxs(h.Task,{children:[e.jsxs(h.TaskDetails,{children:[e.jsx(h.TaskInfo,{children:e.jsx(h.TaskHeadline,{headline:"Snapshot Tables"})}),e.jsxs(h.DetailsProgress,{children:[e.jsx(h.TaskSize,{completed:a.stageCreation.total_tasks,total:a.stageCreation.num_tasks,unit:"task"}),e.jsx(h.TaskDivider,{}),e.jsx(h.TaskProgress,{completed:a.stageCreation.num_tasks,total:a.stageCreation.total_tasks})]})]}),e.jsx(ee,{progress:Q(a.stageCreation.num_tasks,a.stageCreation.total_tasks)})]})})})}function Ls(){var a;const s=j(n=>n.planApply);return R(s.stageRestate)?e.jsxs(D,{className:"flex items-center mb-1",size:k.sm,hasBackground:!1,children:[e.jsx(Y,{className:"w-5 mr-2"}),e.jsx(D.Label,{className:"mr-2 text-sm",children:"No Models To Restate"})]}):e.jsx(U,{meta:(a=s.stageRestate)==null?void 0:a.meta,states:["Restate Models","Restate Models Failed","Restating Models..."]})}function zs(){const s=p.useRef(null),a=j(i=>i.planApply),n=j(i=>i.planAction),t=a.environment,r=a.stageBackfill;p.useEffect(()=>{requestAnimationFrame(()=>{var i;(i=s.current)==null||i.scrollIntoView({behavior:"smooth",block:"start"})})},[]);const{change_categorization:l}=W(),c=p.useMemo(()=>Array.from(l.values()).reduce((i,{category:m,change:x})=>{var o;return(o=x.indirect)==null||o.forEach(u=>{var N;R(i[u.name])&&(i[u.name]=[]),(N=i[u.name])==null||N.push(m.value!==xe.NUMBER_1)}),m.value===xe.NUMBER_3&&(i[x.name]=[!0]),i},{}),[l]),d=p.useMemo(()=>a.backfills.reduce((i,m)=>{const x=a.tasks[m.name]??m;x.interval=m.interval??[];const o=c[m.name];return(R(o)?!1:o.every(Boolean))||(i[m.name]=x),i},{}),[a.backfills,c]);return R(r)||R(t)?e.jsx(e.Fragment,{}):e.jsx("div",{ref:s,children:e.jsx(U,{meta:r.meta,states:["Intervals Backfilled","Intervals Backfilling Failed","Backfilling Intervals..."],showDetails:!0,isOpen:!0,shouldCollapse:!1,children:e.jsx(h,{tasks:d,children:({total:i,completed:m,models:x,completedBatches:o,totalBatches:u})=>e.jsxs(e.Fragment,{children:[e.jsx(h.Summary,{headline:"Target Environment",environment:t,completed:m,total:i,completedBatches:o,totalBatches:u,updateType:n.isApplyVirtual?"Virtual":"Backfill"}),I(x)&&e.jsx(h.Details,{models:x,added:a.added,removed:a.removed,direct:a.direct,indirect:a.indirect,metadata:a.metadata,queue:a.queue,showBatches:!0,showVirtualUpdate:n.isApplyVirtual,showProgress:!0})]})})})})}function Us(){var n;const s=p.useRef(null),a=j(t=>t.planApply);return p.useEffect(()=>{requestAnimationFrame(()=>{var t;(t=s.current)==null||t.scrollIntoView({behavior:"smooth",block:"start"})})},[]),R(a.stagePromote)?e.jsx(e.Fragment,{}):e.jsx("div",{ref:s,children:e.jsx(U,{meta:(n=a.stagePromote)==null?void 0:n.meta,states:["Environment Promoted","Promotion Failed","Promoting Environment..."],children:e.jsx(h.Block,{children:e.jsxs(h.Task,{children:[e.jsxs(h.TaskDetails,{children:[e.jsx(h.TaskInfo,{children:e.jsx(h.TaskHeadline,{headline:`Promote Environment: ${a.stagePromote.target_environment}`})}),e.jsxs(h.DetailsProgress,{children:[e.jsx(h.TaskSize,{completed:a.stagePromote.total_tasks,total:a.stagePromote.num_tasks,unit:"task"}),e.jsx(h.TaskDivider,{}),e.jsx(h.TaskProgress,{completed:a.stagePromote.num_tasks,total:a.stagePromote.total_tasks})]})]}),e.jsx(ee,{progress:Q(a.stagePromote.num_tasks,a.stagePromote.total_tasks)})]})})})})}function Vs(){var l,c,d;const{virtualUpdateDescription:s}=W(),a=j(i=>i.planApply),n=j(i=>i.planOverview),t=n.isLatest?_((l=a.overview)==null?void 0:l.isVirtualUpdate):n.isVirtualUpdate,r=_((d=(c=a.stagePromote)==null?void 0:c.meta)==null?void 0:d.done);return t?e.jsx(U,{meta:{status:O.success,done:r},states:[r?"Virtual Update Completed":"Virtual Update","Virtual Update Failed","Applying Virtual Update..."],children:s}):e.jsx(e.Fragment,{})}function $s(){const s=j(i=>i.planOverview),a=j(i=>i.planApply),{hasChanges:n,added:t,removed:r,direct:l,indirect:c,metadata:d}=ne(a,s);return e.jsx("div",{className:"w-full my-2",children:_(n)&&e.jsxs(e.Fragment,{children:[H(t)&&e.jsx(M,{className:"w-full my-2",headline:"Added Models",type:y.Add,children:e.jsx(M.Default,{type:y.Add,changes:t})}),H(r)&&e.jsx(M,{className:"w-full my-2",headline:"Removed Models",type:y.Remove,children:e.jsx(M.Default,{type:y.Remove,changes:r})}),H(l)&&e.jsx(M,{className:"my-2 w-full",headline:"Modified Directly",type:y.Direct,children:e.jsx(M.Direct,{changes:l})}),H(c)&&e.jsx(M,{className:"my-2 w-full",headline:"Modified Indirectly",type:y.Indirect,children:e.jsx(M.Indirect,{changes:c})}),H(d)&&e.jsx(M,{className:"my-2 w-full",headline:"Modified Metadata",type:y.Default,children:e.jsx(M.Default,{type:y.Default,changes:d})})]})})}function U({meta:s,states:a=["Success","Failed","Running"],isOpen:n=!1,trigger:t,panel:r,children:l,showDetails:c=!0,shouldCollapse:d=!0}){const i=p.useRef(null),m=j(A=>A.planOverview),x=j(A=>A.planApply);if(p.useEffect(()=>{var A;R(i.current)||d&&(x.isFinished||m.isLatest)&&i.current.classList.contains("--is-open")&&((A=i.current)==null||A.click())},[i,m,x,d]),R(s))return e.jsx(e.Fragment,{});const o=s.status===O.success?S.Success:s.status===O.fail?S.Danger:S.Info,[u,N,v]=a,g=s.status===O.success?u:s.status===O.fail?N:v,F=I(r)||I(l);return e.jsx(V,{defaultOpen:n,children:({open:A})=>e.jsxs(e.Fragment,{children:[e.jsx(D,{className:"mb-1",variant:o,size:k.sm,hasBackground:!1,hasBackgroundOnHover:F,children:e.jsx(V.Button,{ref:i,className:f("w-full flex items-center",A&&"--is-open",B(F)&&"cursor-default"),children:R(t)?e.jsx(e.Fragment,{children:s.status===O.init?e.jsx(Fe,{text:g,hasSpinner:!0,size:k.sm,variant:S.Primary,className:"w-full"}):e.jsxs(e.Fragment,{children:[c?e.jsx(e.Fragment,{children:A?e.jsx(ge,{className:"w-5 mr-2"}):e.jsx(ve,{className:"w-5 mr-2"})}):e.jsxs(e.Fragment,{children:[s.status===O.success&&e.jsx(Y,{className:"w-5 mr-2"}),s.status===O.fail&&e.jsx(os,{className:"w-5 mr-2"})]}),e.jsx(D.Label,{className:"mr-2 text-sm w-full",children:e.jsx(Se,{text:g,size:k.sm,variant:o})})]})}):t})}),F&&e.jsxs(V.Panel,{className:"px-2 text-xs mb-2",children:[I(l)&&e.jsx("div",{className:f("p-4 rounded-md",o===S.Danger?"bg-danger-5 text-danger-500":"bg-neutral-5"),children:l}),s.status!==O.fail&&r]})]})})}function Gs({environment:s,onClose:a}){const n=be(),{removeError:t,clearErrors:r}=Oe(),l=j(T=>T.planOverview),c=j(T=>T.planApply),d=j(T=>T.planAction),i=j(T=>T.setPlanAction),m=je(T=>T.setTests),x=R(s==null?void 0:s.isDefault)||_(s==null?void 0:s.isDefault),o=ks({environment:s,isInitialPlanRun:x}),u=Ns({isInitialPlanRun:x}),{refetch:N,cancel:v}=We(s.name,o),{refetch:g,cancel:F}=Ze(s.name,u),{refetch:A}=Qe();function L(){n([{type:P.ResetPlanDates},{type:P.ResetPlanOptions},{type:P.ResetTestsReport}])}function w(){c.reset(),L(),r(),i(new G({value:C.Run}))}function b(){t(Pe.RunPlan),t(Pe.ApplyPlan),L(),a()}function $(){n([{type:P.ResetTestsReport}]),i(new G({value:C.Cancelling}));let T;d.isApplying?T=v:T=F,T(),A().then(()=>{i(new G({value:C.Run}))}).catch(()=>{w()})}function z(){n([{type:P.ResetTestsReport}]),g().catch(console.log)}function E(){m(void 0),l.reset(),c.reset(),n([{type:P.ResetTestsReport}]),N()}return e.jsxs("div",{className:"flex flex-col w-full h-full overflow-hidden",children:[e.jsx(fs,{}),e.jsxs("div",{className:"w-full h-full px-4 overflow-y-scroll hover:scrollbar scrollbar--vertical",children:[e.jsx(ws,{}),d.isCancelling?e.jsx(Hs,{}):e.jsx(Es,{})]}),e.jsx(vs,{planAction:d,apply:z,run:E,cancel:$,close:b,reset:w})]})}function Hs(){return e.jsx("div",{className:"w-full h-full p-4",children:e.jsx("div",{className:"w-full h-full flex justify-center items-center p-4 bg-warning-10 rounded-lg overflow-hidden",children:e.jsxs(Fe,{className:"inline-block",children:[e.jsx(Xe,{variant:S.Warning,className:"w-3 h-3 border border-neutral-10 mr-4"}),e.jsx("h3",{className:"text-2xl text-warning-500 font-bold",children:"Cancelling Plan..."})]})})})}const la=p.memo(function(){const{isPlanOpen:a,setIsPlanOpen:n}=Oe(),t=J(i=>i.environment),[r,l]=p.useState(!1);function c(){l(!0)}const d=_(a)&&B(r);return e.jsx(hs,{show:d,afterLeave:()=>{l(!1),n(!1)},children:e.jsx(_e.Panel,{className:"bg-theme border-8 border-r-0 border-secondary-10 dark:border-primary-10 absolute w-[90%] md:w-[75%] xl:w-[60%] h-full right-0 flex flex-col",children:e.jsx(as,{children:e.jsx(Gs,{onClose:c,environment:t},t.name)})})})});export{la as default};
