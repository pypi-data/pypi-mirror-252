checks:
  - cmd: docker --version
    rsp: ""
  - cmd: podman buildx version
    rsp: buildah 1.29.0

checks_buildx:
  - cmd: docker --version
    rsp: Docker version 20.10.7, build f0df350
  - cmd: docker buildx version
    rsp: buildx 0.29.0

get_git_name:
  - cmd: git rev-parse --show-toplevel
    rsp: /tmp/bl45p
  - cmd: git remote -v
    rsp: |
      github  git@github.com:epics-containers/bl45p.git (fetch)
      github  git@github.com:epics-containers/bl45p.git (push)

get_git_name_https:
  - cmd: git rev-parse --show-toplevel
    rsp: /tmp/ioc-adsimdetector
  - cmd: git remote -v
    rsp: |
      origin  https://github.com/epics-containers/ioc-adsimdetector (fetch)
      origin  https://github.com/epics-containers/ioc-adsimdetector (push)

launch_local_generic:
  - cmd: podman stop -t0 test-ioc
    rsp: "test-ioc stopped"
  - cmd: podman rm -f test-ioc
    rsp: "test-ioc"
  - cmd: podman run --rm --name test-ioc -e DISPLAY -e SHELL --security-opt=label=type:container_runtime_t -v /tmp/ec_tests/ioc-template:/epics/ioc/config/ --entrypoint 'bash' ghcr.io/epics-containers/ioc-adsimdetector-linux.developer:local -c '/epics/ioc/start.sh; bash'
    rsp: True

launch:
  - cmd: podman stop -t0 test-ioc
    rsp: "test-ioc stopped"
  - cmd: podman rm -f test-ioc
    rsp: "test-ioc"
  - cmd: podman run --rm --name test-ioc -e DISPLAY -e SHELL --security-opt=label=type:container_runtime_t -v {data}/iocs/bl45p-ea-ioc-01/config:/epics/ioc/config/ --entrypoint 'bash' ghcr.io/epics-containers/ioc-adaravis-linux-developer:23.9.4 -c '/epics/ioc/start.sh; bash'
    rsp: True

launch_dit:
  - cmd: podman stop -t0 test-ioc
    rsp: "test-ioc stopped"
  - cmd: podman rm -f test-ioc
    rsp: "test-ioc"
  - cmd: podman run --rm --name test-ioc -e DISPLAY -e SHELL --security-opt=label=type:container_runtime_t -v {data}/iocs/bl45p-ea-ioc-01/config:/epics/ioc/config/ --entrypoint 'bash' -dit ghcr.io/epics-containers/ioc-adaravis-linux-developer:23.9.4 -c '/epics/ioc/start.sh; bash'
    rsp: True

debug_last1:
  - cmd: podman images | awk '{{print $3}}' | awk 'NR==2'
    rsp: ea2378de0b5f

debug_last2:
  - cmd: podman run --rm --name debug_build -e DISPLAY -e SHELL --security-opt=label=type:container_runtime_t -v /tmp/bl45p:/epics/ioc/$bl45p --entrypoint bash ea2378de0b5f
    rsp: True

versions:
  - cmd: podman run --rm --name versions -e DISPLAY -e SHELL --security-opt=label=type:container_runtime_t quay.io/skopeo/stable list-tags docker://ghcr.io/epics-containers/bl45p-linux-developer
    rsp: True

get_git_name_gitlab:
  - cmd: git rev-parse --show-toplevel
    rsp: /tmp/bl45p
  - cmd: git remote -v
    rsp: |
      origin https://gitlab-ci-token:[MASKED]@gitlab.diamond.ac.uk/controls/containers/ioc/ioc-template.git (fetch)
      origin https://gitlab-ci-token:[MASKED]@gitlab.diamond.ac.uk/controls/containers/ioc/ioc-template.git (push)

versions_gitlab:
  - cmd: podman run --rm --name versions -e DISPLAY -e SHELL --security-opt=label=type:container_runtime_t quay.io/skopeo/stable list-tags docker://gcr.io/diamond-privreg/controls/prod/ioc/ioc-template-linux-developer
    rsp: True

stop:
  - cmd: podman stop -t0 test-ioc
    rsp: "test-ioc stopped"

exec:
  - cmd: podman ps -f name=test-ioc --format .*
    rsp: test-ioc
  - cmd: podman exec test-ioc bash -c "bash"
    rsp: True

wait_pv:
  - cmd: podman ps -f name=test-ioc --format .*
    rsp: test-ioc
  - cmd: podman exec test-ioc bash -c "caget BL45P-EA-IOC-01:UPTIME"
    rsp: "BL45P-EA-IOC-01:UPTIME 00:00:07"

build:
  - cmd: podman build --target developer --build-arg TARGET_ARCHITECTURE=linux --platform linux/amd64  -t ghcr.io/epics-containers/bl45p-linux-developer:local .
    rsp: True
  - cmd: podman build --target runtime --build-arg TARGET_ARCHITECTURE=linux --platform linux/amd64  -t ghcr.io/epics-containers/bl45p-linux-runtime:local .
    rsp: True
