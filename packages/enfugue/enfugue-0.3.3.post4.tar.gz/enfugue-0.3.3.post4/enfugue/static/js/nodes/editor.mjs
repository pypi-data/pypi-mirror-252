import{isEmpty,deepClone,sleep}from"../base/helpers.mjs";import{View}from"../view/base.mjs";import{FormView}from"../forms/base.mjs";import{InputView}from"../forms/input.mjs";import{ElementBuilder}from"../base/builder.mjs";import{SimpleNotification}from"../common/notify.mjs";import{NodeEditorDecorationsView,NodeConnectionSpline}from"./decorations.mjs";import{NodeView}from"./base.mjs";const E=new ElementBuilder({node:"enfugue-node",nodeCanvas:"enfugue-node-canvas",editorPosition:"enfugue-node-editor-position",positionReadout:"enfugue-node-editor-position-readout",positionReset:"enfugue-node-editor-position-reset",editorZoom:"enfugue-node-editor-zoom",zoomIn:"enfugue-node-editor-zoom-in",zoomOut:"enfugue-node-editor-zoom-out",zoomReadout:"enfugue-node-editor-zoom-readout",zoomReset:"enfugue-node-editor-zoom-reset"});class NodeEditorView extends View{static tagName="enfugue-node-editor";static canvasWidth="auto";static canvasHeight="auto";static maximumZoom=2;static minimumZoom=.125;static zoomPerScroll=.125;static minimumZoomInterval=50;static canMove=!0;static canZoom=!0;static centered=!1;static defaultCursor="default";static disableCursor=!1;static nodeClasses=[NodeView];static classList=["loader-cover"];static zoomInIcon="fa-solid fa-magnifying-glass-plus";static zoomOutIcon="fa-solid fa-magnifying-glass-minus";static bringToFrontOnFocus=!0;constructor(t,e,o){super(t),this.zoom=1,this.constructor.centered?("auto"!=this.constructor.canvasWidth&&(this.left=-this.constructor.canvasWidth/2,isEmpty(e)||(this.left+=e/2)),"auto"!=this.constructor.canvasHeight&&(this.top=-this.constructor.canvasHeight/2,isEmpty(o)||(this.top+=o/2))):(this.left=0,this.top=0),this.nodes=[],this.nodeClasses=[].concat(this.constructor.nodeClasses),this.nodeFocusCallbacks=[],this.nodeCopyCallbacks=[],this.nodeMoveCallbacks=[],this.nodePlaceCallbacks=[],this.setDimensionCallbacks=[],this.decorations=new NodeEditorDecorationsView(t,this,this.constructor.canvasWidth,this.constructor.canvasHeight),this.resizeCallbacks=[],window.addEventListener("resize",(t=>this.windowResized(t)))}getUniqueNodeName(t){let e=t,o=this.nodes.map((t=>t.getName())),s=1;for(;-1!==o.indexOf(e);)e=`${t} ${++s}`;return e}onWindowResize(t){this.resizeCallbacks.push(t)}onNodeFocus(t){this.nodeFocusCallbacks.push(t)}onNodeCopy(t){this.nodeCopyCallbacks.push(t)}onNodeMove(t){this.nodeMoveCallbacks.push(t)}onNodePlace(t){this.nodePlaceCallbacks.push(t)}async windowResized(){if(void 0!==this.node&&!isEmpty(this.node.element)){let[t,e]=[this.node.element.parentElement.clientWidth,this.node.element.parentElement.clientHeight];t<this.width?this.node.addClass("oversize-x"):this.node.removeClass("oversize-x"),e<this.height?this.node.addClass("oversize-y"):this.node.removeClass("oversize-y")}for(let t of this.resizeCallbacks)t()}addNodeClass(t){-1===this.nodeClasses.map((t=>t.name)).indexOf(t.name)&&this.nodeClasses.push(t)}get height(){return"auto"==this.constructor.canvasHeight?void 0!==this.node?this.node.element.clientHeight:0:void 0===this.canvasHeight?this.constructor.canvasHeight:this.canvasHeight}get width(){return"auto"==this.constructor.canvasWidth?void 0!==this.node?this.node.element.clientWidth:0:void 0===this.canvasWidth?this.constructor.canvasWidth:this.canvasWidth}set height(t){if(this.canvasHeight=t,void 0!==this.node){this.node.find(E.getCustomTag("nodeCanvas")).height(t).css("height",`${t}px`),this.decorations.setDimension(this.width,t);for(let t of this.nodes)t.resetDimension()}}set width(t){if(this.canvasWidth=t,void 0!==this.node){this.node.find(E.getCustomTag("nodeCanvas")).width(t).css("width",`${t}px`),this.decorations.setDimension(t,this.height);for(let t of this.nodes)t.resetDimension()}}onSetDimension(t){this.setDimensionCallbacks.push(t)}setDimension(t,e,o=!0,s=!1){if(isEmpty(t)&&(t=this.canvasWidth),isEmpty(e)&&(e=this.canvasHeight),this.canvasWidth=t,this.canvasHeight=e,void 0!==this.node){if(this.node.find(E.getCustomTag("nodeCanvas")).width(t).height(e).css({width:`${t}px`,height:`${e}px`}),this.decorations.setDimension(t,e),o)for(let t of this.nodes)t.resetDimension()}if(this.checkResetCanvasPosition(),s)for(let o of this.setDimensionCallbacks)o(t,e)}getState(){return this.nodes.map((t=>t.getState.apply(t,Array.from(arguments))))}nodeMoved(t){for(let e of this.nodeMoveCallbacks)e(t)}nodePlaced(t){for(let e of this.nodePlaceCallbacks)e(t)}getNodeClass(t){let e=this.nodeClasses.filter((e=>e.name===t)).shift();if(void 0===e)throw`Class name out of scope: ${t}`;return e}async setState(t){for(let t of this.nodes)this.removeNode(t);let e=this.node.find(E.getCustomTag("nodeCanvas"));for(let o of t){let t=new(this.getNodeClass(o.classname))(this);this.nodes.push(t),await t.setState(o),e.append(await t.getNode())}this.nodes=this.nodes.map(((t,e)=>(t.index=e,t))),await this.redraw()}redraw(){return isEmpty(this.redrawPromise)&&(this.redrawPromise=new Promise((async(t,e)=>{for(let t of this.nodes)await t.resetDimension();window.requestAnimationFrame((()=>{this.decorations.draw(),this.redrawPromise=null,t()}))}))),this.redrawPromise}async addNode(t){let e;if("function"==typeof t?e=new t(this,...Array.from(arguments).slice(1)):(e=t,t.editor=this),this.nodes.push(e),this.nodes=this.nodes.map(((t,e)=>(t.index=e,t))),void 0!==this.node){let t=await e.getNode();this.node.find(E.getCustomTag("nodeCanvas")).append(t)}return e}removeNode(t){for(let e of this.nodes)if(e==t)return this.nodes=this.nodes.filter((e=>e!=t)).map(((t,e)=>(t.index=e,t))),void(isEmpty(this.node)||this.node.find(E.getCustomTag("nodeCanvas")).remove(e.node));throw"Could not find node to remove."}async focusNode(t){for(let e of this.nodes)e===t&&this.constructor.bringToFrontOnFocus?e.addClass("focused"):e.removeClass("focused");for(let e of this.nodeFocusCallbacks)await e(t)}reorderNode(t,e){let o=this.nodes.indexOf(e);if(-1===o)return void console.error("Couldn't reorder node, not found in array.");this.nodes=this.nodes.slice(0,o).concat(this.nodes.slice(o+1)),this.nodes.splice(t,0,e);let s=this.node.find(E.getCustomTag("nodeCanvas"));s.remove(e.node),t>o?s.insert(t+4,e.node):s.insert(t+2,e.node)}async copyNode(t){let e=t.getState(),o=await this.addNode(t.constructor);e.name+=" (copy)",await o.setState(e);for(let e of this.nodeCopyCallbacks)await e(o,t);return this.focusNode(o),o}resetCanvasPosition(){isEmpty(this.node)||this.node.find(E.getCustomTag("zoomReset")).trigger("click")}checkResetCanvasPosition(){if(!isEmpty(this.node)){let t=this.node.element.getBoundingClientRect(),e=this.node.find(E.getCustomTag("nodeCanvas")).element.getBoundingClientRect(),o=Math.max(t.x,e.x),s=Math.max(t.y,e.y),i=Math.min(t.x+t.width,e.x+e.width),n=Math.min(t.y+t.height-100,e.y+e.height),h=t.width*t.height,a=e.width*e.height,r=0;o<=i&&s<=n&&(r=(i-o)*(n-s)),r/Math.min(a,h)<=.1&&(SimpleNotification.notify("Resetting canvas position"),this.resetCanvasPosition())}}async build(){let t=await super.build(),e=E.nodeCanvas().css("cursor",this.constructor.defaultCursor),o=E.positionReadout().content("0,0"),s=E.positionReset().content("Reset"),i=E.editorPosition().content(o,s),n=E.zoomReadout().content(`${this.zoom.toFixed(3)}`),h=E.zoomReset().content("Reset"),a=E.zoomIn().content(E.i().class(this.constructor.zoomInIcon)),r=E.zoomOut().content(E.i().class(this.constructor.zoomOutIcon)),d=E.editorZoom().content(a,r,h,n);"auto"==this.constructor.canvasWidth?e.css("width","100%"):e.width(this.width).css("width",`${this.width}px`),"auto"==this.constructor.canvasHeight?e.css("height","100%"):e.height(this.height).css("height",`${this.height}px`),e.css("left",`${this.left}px`),e.css("top",`${this.top}px`),this.decorations.setDimension(this.width,this.height),e.append(await this.decorations.getNode());for(let t of this.nodes)e.append(await t.getNode());if(window.innerWidth<this.width&&t.addClass("oversize-x"),window.innerHeight<this.height&&t.addClass("oversize-y"),t.append(e),this.constructor.disableCursor)t.css("pointer-events","none");else{if(this.constructor.canMove){t.append(i);let n=!1;e.on("mousedown,touchstart",(s=>{if("mousedown"===s.type&&(!(2===s.which||1===s.which&&(s.ctrlKey||s.altKey||s.metaKey))||n))return;s.preventDefault(),s.stopPropagation();let i,h,a=this.left,r=this.top;s.touches?(i=s.touches[0].clientX,h=s.touches[0].clientY):(i=s.clientX,h=s.clientY),n=!0,e.css("cursor","grabbing"),e.on("mousemove,touchmove",(s=>{let n,d,c,l;if(s.preventDefault(),s.touches?(n=s.touches[0].clientX-i,d=s.touches[0].clientY-h):(n=s.clientX-i,d=s.clientY-h),a=this.left+n,r=this.top+d,e.css({left:`${a}px`,top:`${r}px`}),this.constructor.centered){let e=this.width/2-t.element.clientWidth/2,o=this.height/2-t.element.clientHeight/2;c=-e-a/this.zoom,l=-o-r/this.zoom}else c=-a/this.zoom,l=-r/this.zoom;1!=this.zoom&&(c=c.toFixed(2),l=l.toFixed(2)),o.content(`${c},${l}`)})).on("mouseup,mouseleave,touchend,touchleave",(s=>{if(s.preventDefault(),s.stopPropagation(),s.touches)this.left=a,this.top=r;else{let t,e;t=s.clientX-i,e=s.clientY-h,this.left+=t,this.top+=e}let d,c;if(e.off("mouseup,mousemove,mouseleave,touchend,touchleave,touchmove"),e.css({left:`${this.left}px`,top:`${this.top}px`,cursor:this.constructor.defaultCursor}),this.constructor.centered){let e=this.width/2-t.element.clientWidth/2,o=this.height/2-t.element.clientHeight/2;d=-e-this.left/this.zoom,c=-o-this.top/this.zoom}else d=-this.left/this.zoom,c=-this.top/this.zoom;1!=this.zoom&&(d=d.toFixed(2),c=c.toFixed(2)),o.content(`${d},${c}`),n=!1}))})),s.on("click",(s=>{s.preventDefault(),s.stopPropagation(),this.constructor.centered?(this.left=-this.width/2*this.zoom+t.element.clientWidth/2,this.top=-this.height/2*this.zoom+t.element.clientHeight/2):(this.left=0,this.top=0),o.content("0,0"),e.css({left:`${this.left}px`,top:`${this.top}px`})}))}if(this.constructor.canZoom){t.append(d);let i,c=(s,i,h)=>{let a=s-this.zoom,r=-i*a,d=-h*a;if(this.left+=r,this.top+=d,this.zoom=s,n.content(this.zoom.toFixed(3)),e.css({left:`${this.left}px`,top:`${this.top}px`,transform:`scale(${this.zoom})`}),this.constructor.canMove){let e,s;if(this.constructor.centered){let o=this.width/2-t.element.clientWidth/2,i=this.height/2-t.element.clientHeight/2;e=-o-this.left/this.zoom,s=-i-this.top/this.zoom}else e=-this.left/this.zoom,s=-this.top/this.zoom;1!=this.zoom&&(e=e.toFixed(2),s=s.toFixed(2)),o.content(`${e},${s}`)}this.zoom>1?t.addClass("zoom-in"):t.removeClass("zoom-in"),this.zoom<1?t.addClass("zoom-out"):t.removeClass("zoom-out")};e.on("wheel",(t=>{if("ENFUGUE-NODE-CANVAS"!==t.target.tagName){let e=t.deltaY>0,o=t.target;for(;null!=o&&"ENFUGUE-NODE-EDITOR"!==o.tagName&&"ENFUGUE-NODE-CANVAS"!==o.tagName;){if(o.scrollHeight!==o.offsetHeight&&"ENFUGUE-NODE-CONTENTS"!==o.tagName){let t=o.offsetHeight+o.scrollTop,s=getComputedStyle(o).overflowY;if(-1!==["auto","scroll"].indexOf(s)){if(o.scrollHeight-t>1&&e)return;if(o.scrollTop>0&&!e)return}}o=o.parentElement}}t.preventDefault(),t.stopPropagation();let e=(new Date).getTime();if(!isEmpty(i)&&e-i<this.constructor.minimumZoomInterval)return;i=e;let o,s=1;this.zoom>=5?s=4:this.zoom>=2.5&&(s=2),o=t.deltaY<0?this.zoom+this.constructor.zoomPerScroll*s:this.zoom-this.constructor.zoomPerScroll*s;let n=t.target,h=t.offsetX,a=t.offsetY;for(;"ENFUGUE-NODE-CANVAS"!=n.tagName&&"ENFUGUE-NODE-EDITOR-CANVAS"!=n.tagName;)h+=n.offsetLeft,a+=n.offsetTop,n=n.parentElement;o>=this.constructor.minimumZoom&&o<=this.constructor.maximumZoom&&o!=this.zoom&&c(o,h,a)})),a.on("click",(t=>{t.preventDefault(),t.stopPropagation();let e=this.zoom+this.constructor.zoomPerScroll;e>=this.constructor.minimumZoom&&e<=this.constructor.maximumZoom&&e!=this.zoom&&c(e,this.width/2,this.height/2)})).on("dblclick",(t=>{t.preventDefault()})),r.on("click",(t=>{t.preventDefault(),t.stopPropagation();let e=this.zoom-this.constructor.zoomPerScroll;e>=this.constructor.minimumZoom&&e<=this.constructor.maximumZoom&&e!=this.zoom&&c(e,this.width/2,this.height/2)})).on("dblclick",(t=>{t.preventDefault()})),h.on("click",(t=>{t.preventDefault(),t.stopPropagation(),this.zoom=1,n.content("1.000"),e.css({transform:"scale(1)"}),s.trigger("click")}))}}return t}}class NodesView extends NodeEditorView{static tagName="enfugue-nodes";static canMove=!1;static canZoom=!1}export{NodeEditorView,NodesView};
