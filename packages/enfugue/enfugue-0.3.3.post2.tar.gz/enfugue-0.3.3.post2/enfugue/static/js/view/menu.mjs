import{View,ParentView}from"./base.mjs";import{ElementBuilder}from"../base/builder.mjs";import{isEmpty,getPointerEventCoordinates}from"../base/helpers.mjs";const E=new ElementBuilder({categoryHeader:"enfugue-menu-category-header",categoryItems:"enfugue-menu-category-items",categoryButton:"enfugue-menu-category-button",toolbarOperations:"enfugue-toolbar-operations",toolbarInputs:"enfugue-toolbar-inputs",toolbarItem:"enfugue-toolbar-item"});function formatName(e,t=null){if(isEmpty(t))return e;let i="<span>",s=!1;for(let a=0;a<e.length;a++){let n=e[a];s||n.toLowerCase()!==t.toLowerCase()?i+=n:(i+=`</span><span class="shortcut">${n}</span>`,s=!0)}return">"!==i[i.length-1]&&(i+="</span>"),i}class MenuView extends ParentView{static tagName="enfugue-menu";get activeCategory(){return this.children.filter((e=>e instanceof MenuCategoryView&&e.hasClass("active"))).shift()}getCategory(e){return this.children.filter((t=>t instanceof MenuCategoryView&&t.name===e)).shift()}get isActive(){return!isEmpty(this.activeCategory)}hideCategories(){for(let e of this.children)e instanceof MenuCategoryView&&e.removeClass("active")}async fireCategoryShortcut(e){for(let t of this.children)if(t instanceof MenuCategoryView){if(!isEmpty(t.shortcut)&&t.shortcut.toLowerCase()===e.toLowerCase())return void this.toggleCategory(t.name);if(t.hasClass("active"))for(let i of t.children)if(!isEmpty(i.shortcut)&&i.shortcut.toLowerCase()===e.toLowerCase())return await i.activate(),void this.hideCategories()}}startHideTimer(){this.hideTimer=setTimeout((()=>{this.hideCategories()}),500)}stopHideTimer(){clearTimeout(this.hideTimer)}toggleCategory(e){let t,i=!1;this.stopHideTimer();for(let s of this.children)s instanceof MenuCategoryView&&(s.name===e?(i=!0,t=!s.hasClass("active"),s.toggleClass("active")):s.removeClass("active"));return i||console.warn("No category named",e),t}setCategory(e){for(let t of this.children)t instanceof MenuCategoryView&&(t.name===e?t.addClass("active"):t.removeClass("active"))}removeCategory(e){let t=this.getCategory(e);return!isEmpty(t)&&(this.removeChild(t),!0)}addCategory(e,t){let i=0;for(;this.children[i]instanceof MenuCategoryView;)i++;return this.insertChild(i,MenuCategoryView,e,t)}async build(){let e=await super.build();return e.on("click",(e=>e.stopPropagation())).on("touchmove",(t=>{let[i,s]=getPointerEventCoordinates(t,e.element);for(let e of this.children)if(e instanceof MenuCategoryView){let t=e.node.element.getBoundingClientRect();t.x<=i&&i<t.x+t.width&&this.setCategory(e.name)}})),window.addEventListener("click",(()=>this.hideCategories())),e}}class MenuCategoryView extends ParentView{static tagName="enfugue-menu-category";constructor(e,t,i){super(e),this.name=t,this.shortcut=i,this.buttons=[]}setName(e){this.name=e,void 0!==this.node&&this.node.find(E.getCustomTag("categoryHeader")).find("span").content(formatName(this.name,this.shortcut))}addButton(e,t){let i=E.categoryButton().content(E.i().class(e)).on("click",(e=>{e.preventDefault(),e.stopPropagation(),t()}));return this.buttons.push(i),void 0!==this.node&&this.node.find(E.getCustomTag("categoryHeader")).append(i),i}async insertChild(e,t){let i=new t(this.config,...Array.from(arguments).slice(2));return this.children=this.children.slice(0,e).concat([i]).concat(this.children.slice(e)),void 0!==this.node&&this.node.insert(e+1,await i.getNode()),i}async addCategory(e){let t=0;for(;this.children[t]instanceof MenuCategoryView;)t++;return this.insertChild(t,MenuCategoryView,e)}async addItem(e,t,i){return await this.addChild(IconItemView,e,t,i)}async build(){let e=await super.build(),t=E.categoryHeader().content(E.span().content(formatName(this.name,this.shortcut)));for(let e of this.buttons)t.append(e);return e.prepend(t).on("click",(()=>this.parent.toggleCategory(this.name))).on("mouseleave",(()=>this.parent.startHideTimer())).on("mouseenter",(()=>{this.parent.isActive&&this.parent.setCategory(this.name),this.parent.stopHideTimer()})).on("mousemove",(()=>this.parent.stopHideTimer())),e}}class MenuItemView extends View{static tagName="enfugue-menu-item";constructor(e,t,i){super(e),this.name=t,this.shortcut=i,this.callbacks=[]}onClick(e){this.callbacks.push(e)}setName(e){this.name=e,void 0!==this.node&&this.node.find("span").content(this.name)}async activate(){for(let e of this.callbacks)await e()}async build(){let e=await super.build();return e.prepend(E.span().content(formatName(this.name,this.shortcut))),e.on("click",(e=>{e.preventDefault(),this.activate()})),e}}class IconItemView extends MenuItemView{constructor(e,t,i,s){super(e,t,s),this.icon=i}setIcon(e){this.icon=e,isEmpty(this.node)||(e.startsWith("http")?this.node.find("img").src(e):this.node.find("i").class(e))}async build(){let e=await super.build();return isEmpty(this.icon)||(this.icon.startsWith("http")||this.icon.startsWith("/")?e.prepend(E.img().src(this.icon)):e.prepend(E.i().class(this.icon))),e}}class SidebarView extends ParentView{static tagName="enfugue-sidebar";addItem(e,t){return this.addChild(SidebarItemView,e,t)}}class SidebarItemView extends IconItemView{static tagName="enfugue-sidebar-item"}class ToolbarView extends ParentView{static tagName="enfugue-toolbar";addItem(e,t){return this.addChild(ToolbarItemView,e,t)}}class ToolbarItemView extends IconItemView{static tagName="enfugue-toolbar-item";async build(){let e=await super.build();return e.data("tooltip",this.name),e}}export{MenuView,MenuItemView,MenuCategoryView,IconItemView,SidebarView,SidebarItemView,ToolbarView,ToolbarItemView};
