import{uuid,createEvent,isEmpty,parseSelector}from"./helpers.mjs";let defaultTags=["div","span","input","br","hr","a","p","i","strong","em","button","input","select","option","img","h1","h2","h3","h4","ul","ol","li","table","tbody","thead","tr","td","th","canvas","label","iframe","form","textarea","pre","fieldset","legend","code","style","link","script","video","source"],namespacedTags={"http://www.w3.org/2000/svg":["svg","path","rect","circle"]},defaultAttributes=["id","type","src","action","target","placeholder","href","disabled","selected","alt","value","width","height","x","y","d","cx","cy","r","for","name","fill","stroke","rel","autoplay","controls","loop","muted"],namespacedAttributes={"http://www.w3.org/2000/xlink":["xref"]};class FrameStacker{constructor(){this.callbacks=[],this.next=[],this.waiting=!1}requestFrame(e){this.callbacks.push(e),this.waiting||(window.requestAnimationFrame((()=>this.fireCallbacks())),this.waiting=!0)}requestNextFrame(e){this.next.push(e)}fireNextCallbacks(){for(let e of this.next)e();this.next=[]}fireCallbacks(){for(let e of this.callbacks)e();window.requestAnimationFrame((()=>this.fireNextCallbacks())),this.callbacks=[],this.waiting=!1}}const globalFrame=new FrameStacker;class DOMElement{static assignDefaultAttributes=!0;static assignNamespacedAttributes=!0;static assignElementId=!0;constructor(e,t){this.nameSpace=t,this.elementId=uuid(),this.tagName=e,this.attributes={},this.namespacedAttributes={},this.contentArray=[],this.elementClasses=[],this.events={},this.styles={};let n=0,i=this;if(this.constructor.assignDefaultAttributes)for(n=0;n<defaultAttributes.length;n++)this[defaultAttributes[n]]=function(e){return function(t){return i.attr(e,t)}}(defaultAttributes[n]);if(this.constructor.assignNamespacedAttributes)for(let e in namespacedAttributes)for(n=0;n<namespacedAttributes[e].length;n++)this[namespacedAttributes[e][n]]=function(t){return function(n){return i.attr(t,n,e)}}(namespacedAttributes[e][n]);"svg"===e&&(this.attributes.xmlns="http://www.w3.org/2000/svg",this.attributes.version="1.1",this.attributes["xmlns:xlink"]="http://www.w3.org/1999/xlink"),this.constructor.assignElementId&&this.data({"element-id":this.elementId})}static fromNode(e){let t=new DOMElement(e.tagName.toLowerCase()),n=Array.from(e.children);for(let n of e.getAttributeNames())-1!=["style"].indexOf(n)&&t.attr(n,e.getAttribute(n));for(let n of e.classList)t.addClass(n);if(n.length>0)t.contentArray=n.map((e=>DOMElement.fromNode(e)));else{let n=e.innerText;n.length>0&&t.content(n)}return t.element=e,t}editable(){return this.attr("contenteditable","true").attr("tabindex",0).on("input",(e=>{this.contentArray[0]=this.element.innerText}))}empty(){return this.contentArray=[],void 0!==this.element&&this.setDOMContent(this.contentArray),this}matchesSelector(e){if(void 0!==this.element)return this.element.matches(e);{let t=parseSelector(e);if(!isEmpty(t.tags)&&-1===t.tags.indexOf(this.tagName))return!1;if(!isEmpty(t.ids)&&-1===t.ids.indexOf(this.attr("id")))return!1;if(!isEmpty(t.classes))for(let e of t.classes)if(-1==this.elementClasses.indexOf(e))return!1;if(!isEmpty(t.attributes))for(let e in t.attributes)if(this.attr(e)!==t.attributes[e])return!1;return!0}}css(e,t){if(void 0===t){if("object"==typeof e){for(let t in e)this.css(t,e[t]);return this}return this.styles[e]}null===t?delete this.styles[e]:("number"==typeof t&&-1!==["left","right","top","bottom","width","height"].indexOf(e)&&(t+="px"),this.styles[e]=t);let n=this;return this.attr("style",Object.getOwnPropertyNames(this.styles).map((e=>`${e}: ${n.styles[e]}`)).join("; ")),this}show(){return void 0===this.display?this.css("display",null):this.css("display",this.display),this}hide(){return void 0===this.display&&"none"!==this.styles.display&&(this.display=this.styles.display),this.css("display","none"),this}attr(e,t,n){return void 0===t?void 0===n?this.attributes[e]:this.namespacedAttributes.hasOwnProperty(n)?this.namespacedAttributes[n][e]:void 0:(null===t||!1===t?void 0===n?this.attributes.hasOwnProperty(e)&&(delete this.attributes[e],void 0!==this.element&&this.removeDOMAttribute(e,t)):this.attributes.hasOwnProperty(n)&&(delete this.namespacedAttributes[namespace][e],void 0!==this.element&&this.removeDOMAttributeNS(e,t,n)):(!0===t&&(t=e),void 0===n?(this.attributes[e]=t,void 0!==this.element&&this.setDOMAttribute(e,t)):(this.namespacedAttributes.hasOwnProperty(n)||(this.namespacedAttributes[n]={}),this.namespacedAttributes[n][e]=t,void 0!==this.element&&this.setDOMAttributeNS(e,t,n))),this)}hasClass(e){return-1!==this.elementClasses.indexOf(e)}class(e){for(let e of this.elementClasses)this.removeClass(e);return this.addClass(e)}addClass(e){for(let t of e.split(" "))this.elementClasses.push(t),void 0!==this.element&&this.element.classList.add(t);return this}removeClass(e){return this.elementClasses=this.elementClasses.filter((t=>t!==e)),void 0!==this.element&&this.element.classList.remove(e),this}toggleClass(e){return this.hasClass(e)?this.removeClass(e):this.addClass(e),this}data(e,t){if(void 0===e)return this.attributes.filter((e=>e.key.startsWith("data")));if("string"==typeof e){if(void 0===t)return this.attr("data-"+e);this.attr("data-"+e,t)}else{let t;for(t in e)this.attr("data-"+t,e[t])}return this}content(){return this.empty(),this.contentArray=Array.from(arguments),void 0===this.contentArray[0]&&(this.contentArray=[]),void 0!==this.element&&this.setDOMContent(this.contentArray),this}prepend(){return this.contentArray=Array.from(arguments).concat(this.contentArray),void 0!==this.element&&this.setDOMContent(this.contentArray),this}append(){return this.contentArray=this.contentArray.concat(Array.from(arguments)),void 0!==this.element&&this.appendDOMContent(this.contentArray[this.contentArray.length-1]),this}extend(e){let t=e.length;if(this.contentArray=this.contentArray.concat(e),void 0!==this.element)for(let e=this.contentArray.length-t;e<this.contentArray.length;e++)this.appendDOMContent(this.contentArray[e]);return this}insert(e,t){return this.contentArray=this.contentArray.slice(0,e).concat([t]).concat(this.contentArray.slice(e)),void 0!==this.element&&this.setDOMContent(this.contentArray),this}insertAfter(e,t){let n=this.getChildIndex(e);return this.insert(n+1,t)}insertBefore(e,t){let n=this.getChildIndex(e);return this.insert(n,t)}swapChildren(e,t){let n=this.contentArray[t];return this.contentArray[t]=this.contentArray[e],this.contentArray[e]=n,this}getChildIndex(e){let t,n,i;if(t=e instanceof DOMElement?e.elementId:e.getAttribute("data-element-id"),void 0!==t)for(let e=0;e<this.contentArray.length;e++){if(this.contentArray[e]instanceof DOMElement)n=this.contentArray[e].elementId;else{if(!(this.contentArray[e]instanceof Node))continue;n=this.contentArray[e].getAttribute("data-element-id")}if(void 0!==n&&n===t){i=e;break}}return i}getChildIndexById(e){let t;for(let n=0;n<this.contentArray.length;n++)if(t=this.contentArray[n]instanceof DOMElement?this.contentArray[n].elementId:this.contentArray[n].getAttribute("data-element-id"),t===e)return n;return null}is(e){let t;return e instanceof DOMElement?t=e.elementId:e instanceof Node&&(t=e.getAttribute("data-element-id")),t===this.elementId}remove(e){if(void 0===e)return void 0!==this.element&&(this.element.remove(),this.element=void 0),this;{let t=this.getChildIndex(e);if(void 0!==t){let e=this.contentArray[t];return this.contentArray=this.contentArray.slice(0,t).concat(this.contentArray.slice(t+1)),void 0!==this.element&&this.removeDOMContent(e),this}}return console.error("Couldn't find child element",e),this}replace(e,t){let n=this.getChildIndex(e),i=this.element;if(void 0!==n)this.contentArray=this.contentArray.slice(0,n).concat([t]).concat(this.contentArray.slice(n+1)),void 0!==i&&window.requestAnimationFrame((function(){i.childNodes[n].replaceWith(t.render())}));else if(this.contentArray.length>0)for(let n of this.contentArray)n.replace(e,t);return this}isEmpty(){return 0==this.contentArray.length}children(){return this.contentArray}getChild(e){return e<0&&(e=this.contentArray.length+e),this.contentArray[e]}getText(){return this.children().map((e=>"string"==typeof e?e:e instanceof DOMElement?e.getText():"")).join("")}firstChild(){return this.contentArray[0]}lastChild(){return this.contentArray[this.contentArray.length-1]}on(e,t,n){for(let i of e.split(","))void 0!==this.element&&this.setDOMEvent(i,t,n),this.events.hasOwnProperty(i)?this.events[i].push([t,n]):this.events[i]=[[t,n]];return this}off(e,t,n){for(let i of e.split(",")){if(void 0!==this.element&&void 0!==this.events[i]){if(void 0!==t)return this.removeDOMEvent(i,t,n),this.events[i]=this.events[i].filter((([e,n])=>e!==t)),this;for(let[e,t]of this.events[i])this.removeDOMEvent(i,e,t)}delete this.events[i]}return this}val(e,t){if(void 0===e){if(void 0===this.element)return;return this.element.value}if("select"==this.tagName)for(let t of this.contentArray)t.value()===e?t.selected(!0):t.selected(!1);else if("textarea"===this.tagName)void 0!==this.element?this.element.innerText=e:this.on("render",(()=>{this.val(e).off("render")}));else if("input"===this.tagName&&"checkbox"===this.attr("type"))this.attr("checked",e),void 0!==this.element&&(this.element.checked=e);return void 0!==this.element&&(this.element.value=e),this.value(e),!1!==t&&this.trigger("change"),this}focus(){return this.element.focus(),this}select(){return this.element.select(),this}trigger(e){return void 0!==this.element&&("string"==typeof e&&(e=createEvent(e)),this.element.dispatchEvent(e)),this}removeDOMAttribute(e){if(void 0===this.element)throw"Element has not been rendered, cannot remove attributes.";return this.element.removeAttribute(e),this}removeDOMAttributeNS(e,t){if(void 0===this.element)throw"Element has not been rendered, cannot remove attributes.";return this.element.removeAttributeNS(t,e),this}setDOMAttribute(e,t){if(void 0===this.element)throw"Element has not been rendered, cannot set attributes.";return this.element.setAttribute(e,t),this}setDOMAttributeNS(e,t,n){if(void 0===this.element)throw"Element has not been rendered, cannot set attributes.";return this.element.setAttributeNS(n,e,t),this}addDOMClass(e){if(void 0===this.element)throw"Element has not been rendered, cannot set attributes.";return this.element.classList.add(e),this}setDOMEvent(e,t,n){if(void 0===this.element)throw"Element has not been rendered, cannot set event listeners.";return this.element.addEventListener(e,t,n),this}removeDOMEvent(e,t){if(void 0===this.element)throw"Element has not been rendered, cannot set event listeners.";void 0!==t&&this.element.removeEventListener(e,t)}appendDOMContent(e){if(void 0===this.element)throw"Element has not been rendered, cannot append content.";if(e instanceof DOMElement){if(void 0===e.element&&e.render(this.element),e.element instanceof DocumentFragment)return this;this.element.appendChild(e.element)}else try{if(e instanceof DocumentFragment)return this;this.element.appendChild(e)}catch(t){if(null==e)throw"Cannot add null or undefined content to "+this.tagName;console.error("Could not add content of type",e.constructor.name,e,"to",this),console.error(t)}return this}removeDOMContent(e){if(void 0===this.element)throw"Element has not been rendered, cannot remove content.";if(e instanceof DOMElement){if(void 0===e.element)return this;if(e.element instanceof DocumentFragment)throw"Shadow elements cannot be detached; you must remove the parent element.";this.element.removeChild(e.element)}else this.element.removeChild(e);return this}setDOMContent(e){if(void 0===this.element)throw"Element has not been rendered, cannot set content.";let t=this;return globalFrame.requestFrame((function(){if(void 0!==t.element){for(;t.element.firstChild;)t.element.removeChild(t.element.firstChild);if(Array.isArray(e)||(e=[e]),1==e.length&&"string"==typeof e[0])return"CODE"===t.element.tagName||"PRE"===t.element.tagName?t.element.innerText=e[0]:t.element.innerHTML=e[0],t.element;if(e.length>=1){let n=0;for(n=0;n<e.length;n++)if(e[n]instanceof DOMElement){if(void 0===e[n].element&&e[n].render(t.element),e[n].element instanceof DocumentFragment)continue;t.element.appendChild(e[n].element)}else try{if(e[n]instanceof DocumentFragment)continue;t.element.appendChild(e[n])}catch(i){if(null===e[n]||void 0===e[n])throw console.error("Could not add null or undefined content to",t),console.trace(i),"Cannot add null or undefined content to "+t.tagName;console.error("Could not add content of type",e[n].constructor.name,e[n],"to",t),console.error(i),console.trace(i)}}}})),this}createDOMElement(){return document.createElement(this.tagName)}render(){let e,t,n,i=void 0===this.element,s=[].concat(this.contentArray);void 0===this.element&&(this.element=this.createDOMElement());for(let e in s)s[e]instanceof DOMElement&&(s[e]=s[e].render(this.element));for(e in this.attributes)this.setDOMAttribute(e,this.attributes[e]);for(t of this.elementClasses)this.addDOMClass(t);for(n in this.events)for(let[e,t]of this.events[n])this.setDOMEvent(n,e,t);return this.setDOMContent(s),i&&this.trigger("render"),"select"===this.tagName&&void 0!==this.element&&globalFrame.requestNextFrame((()=>{if(isEmpty(this.attributes.value))this.element.childNodes.length>0&&(this.element.childNodes[0].selected=!0);else for(let e of this.element.childNodes)if(e.value==this.attributes.value)return void(e.selected=!0)})),"input"===this.tagName&&void 0!==this.attributes.value&&(this.element.value=this.attributes.value),this.element}async awaitRender(){if(void 0===this.element){let e=this;return this.render(),new Promise((function(t,n){e.on("ready",(()=>t(e.element)))}))}return Promise.resolve(this.element)}redraw(){this.element.innerHTML=this.element.innerHTML}findDeep(e){for(let t of this.children()){if(t instanceof DOMElement&&t.matchesSelector(e))return t;let n=t.findDeep(e);if(null!=n)return n}return null}findWide(e){for(let t of this.children())if(t instanceof DOMElement&&t.matchesSelector(e))return t;for(let t of this.children())if(t instanceof DOMElement){let n=t.findWide(e);if(null!=n)return n}return null}findAllDeep(e){let t=[];for(let n of this.children())n instanceof DOMElement&&(n.matchesSelector(e)&&t.push(n),t=t.concat(n.findAllDeep(e)));return t}findAllWide(e){let t=[];for(let n of this.children())n instanceof DOMElement&&n.matchesSelector(e)&&t.push(n);for(let n of this.children())n instanceof DOMElement&&(t=t.concat(n.findAllDeep(e)));return t}find(e){return this.findWide(e)}findAll(e){return this.findAllWide(e)}scrollToBottom(){return void 0!==this.element&&this.element.scrollTo(0,this.element.scrollHeight),this}}class DOMElementList{static fromNodeList(e){return new DOMElementList(Array.from(e).map((e=>{if(e instanceof Node)return DOMElement.fromNode(e);if(e instanceof DOMElement)return e;throw console.error("Cannot parse element",e),new Error("Invalid argument.")})))}constructor(e){this.elements=e}each(e){for(let t of this.children())e.apply(t)}children(){return this.elements}}class ShadowDOMElement extends DOMElement{static assignElementId=!1;createDOMElement(){if(isEmpty(this.parentElement))throw"Shadow DOMs must be attached to an element, they cannot be instantiated on their own.";try{return this.parentElement.attachShadow({mode:"open"})}catch(e){if(this.parentElement.shadowRoot)return this.parentElement.shadowRoot;throw e}}setDOMAttribute(e,t){return console.warn("DOM attributes not supported on shadow elements, ignoring setting",e,"=",t),this}setDOMAttributeNS(e,t,n){return console.warn("DOM attributes not supported on shadow elements, ignoring setting",`${n}:${e}`,"=",t),this}setDOMEvent(e,t,n){return console.warn("DOM events not supported on shadow elements, ignoring adding listener for",e),this}removeDOMEvent(e,t){return console.warn("DOM events not supported on shadow elements, ignoring removing listener for",e),this}removeDOMAttribute(e){return console.warn("DOM attributes not supported on shadow elements, ignoring removing",e),this}removeDOMAttributeNS(e,t){return console.warn("DOM attributes not supported on shadow elements, ignoring removing",`${t}:${e}`),this}addDOMClass(e){return console.warn("DOM classes not supported on shadow elements, ignoring adding",e),this}render(e){return this.parentElement=e,super.render()}}let Builder=function(e){let t,n,i=function(e){if(e instanceof DOMElement||e instanceof DOMElementList)return e;if(Array.isArray(e)||e instanceof HTMLCollection||e instanceof NodeList)return DOMElementList.fromNodeList(e);if(e instanceof Node)return DOMElement.fromNode(node);if("string"==typeof e){let t=document.querySelectorAll(e);return 1===t.length?DOMElement.fromNode(t[0]):DOMElementList.fromNodeList(t)}return this};i.createElement=function(e,t){return new DOMElement(e,t)},i.createShadow=function(){return new ShadowDOMElement};for(let t in e)i[t]=()=>i.createElement(e[t]);for(i.getCustomTag=t=>isEmpty(e)?void 0:e[t],t=0;t<defaultTags.length;t++)i[defaultTags[t]]=function(e){return function(){return i.createElement(e)}}(defaultTags[t]);for(n in namespacedTags)for(t=0;t<namespacedTags[n].length;t++)i[namespacedTags[n][t]]=function(e,t){return function(){return i.createElement(e,t)}}(namespacedTags[n][t],n);return i};export{Builder as ElementBuilder,DOMElement};
