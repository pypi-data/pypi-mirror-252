import{isEmpty}from"../../base/helpers.mjs";import{Controller}from"../base.mjs";import{ToolbarView}from"../../view/menu.mjs";import{VectorView}from"../../view/vector.mjs";import{AnimationFormView}from"../../forms/enfugue/animation.mjs";class AnimationController extends Controller{static vectorPadding=512;getState(i=!0){return{animation:this.animationForm.values,motion:{vector:this.vector.value}}}getDefaultState(){return{motion:{vector:[]},animation:{animationEnabled:!1,animationEngine:"ad_hsxl",animationFrames:16,animationRate:8,animationSlicing:!0,animationSize:16,animationStride:8,animationLoop:null,animationRate:8,animationDecodeChunkSize:1,animationDenoisingIterations:1,animationInterpolation:null,stableVideoAnimationFrames:14,stableVideoMotionBucketId:127,stableVideoFps:7,stableVideoNoiseAugStrength:.02,stableVideoMinGuidanceScale:1,stableVideoMaxGuidanceScale:3,stableVideoUseDrag:!1,stableVideoReflect:!1,stableVideoModel:"svd",stableVideoGaussianSigma:20,stableVideoMotionVectorRepeatMode:"extend"}}}setState(i){isEmpty(i.animation)||this.animationForm.setValues(i.animation).then((()=>this.animationForm.submit())),isEmpty(i.motion)||(this.vector.value=i.motion.vector||[])}resize(i=null,t=null){this.vector.resizeCanvas((i||this.engine.width)+2*this.constructor.vectorPadding,(t||this.engine.height)+2*this.constructor.vectorPadding)}getOffsetVectors(i){return i.map((i=>i.map((i=>{let t={anchor:[i.anchor[0]-this.constructor.vectorPadding,i.anchor[1]-this.constructor.vectorPadding]};return isEmpty(i.control_1)||(t.control_1=[i.control_1[0]-this.constructor.vectorPadding,i.control_1[1]-this.constructor.vectorPadding]),isEmpty(i.control_2)||(t.control_2=[i.control_2[0]-this.constructor.vectorPadding,i.control_2[1]-this.constructor.vectorPadding]),t}))))}async prepareMenu(i){let t=await i.addItem("Lock Motion Input","fa-solid fa-lock");(await i.addItem("Clear Motion Input","fa-solid fa-delete-left")).onClick((()=>{this.vector.value=[],this.vector.changed()})),t.onClick((()=>{this.vector.hasClass("locked")?(this.vector.removeClass("locked"),t.setIcon("fa-solid fa-lock")):(this.vector.addClass("locked"),t.setIcon("fa-solid fa-unlock"))}))}hideMotionVectors(){this.vector.hide(),this.vectorToolbar.hide(),this.application.container.classList.remove("motion-vectors"),this.engine.motionVectors=null}showMotionVectors(){this.vector.show(),this.vectorToolbar.show(),this.application.container.classList.add("motion-vectors")}async initialize(){this.animationForm=new AnimationFormView(this.config),this.vector=new VectorView(this.config,this.engine.width+2*this.constructor.vectorPadding,this.engine.height+2*this.constructor.vectorPadding),this.vector.css({left:`-${this.constructor.vectorPadding}px`,top:`-${this.constructor.vectorPadding}px`}),this.vector.hide(),this.vector.onChange((()=>this.animationForm.submit())),this.application.sidebar.addChild(this.animationForm),this.animationForm.onSubmit((async i=>{if(i.animationEnabled){if(this.engine.animationFrames=i.animationFrames,this.engine.animationRate=i.animationRate,this.engine.animationInterpolation=i.animationInterpolation,this.engine.animationDecodeChunkSize=i.animationDecodeChunkSize,this.engine.animationInterpolation=i.animationInterpolation,isEmpty(i.animationEngine)||"ad_hsxl"===i.animationEngine)this.hideMotionVectors(),this.engine.animationEngine="ad_hsxl",this.engine.animationDenoisingIterations=i.animationDenoisingIterations,this.engine.animationLoop=i.animationLoop,i.animationMotionScaleEnabled?this.engine.animationMotionScale=i.animationMotionScale:this.engine.animationMotionScale=null,i.animationPositionEncodingSliceEnabled?(this.engine.animationPositionEncodingTruncateLength=i.animationPositionEncodingTruncateLength,this.engine.animationPositionEncodingScaleLength=i.animationPositionEncodingScaleLength):(this.engine.animationPositionEncodingTruncateLength=null,this.engine.animationPositionEncodingScaleLength=null),i.animationSlicing||i.animationLoop?(this.engine.animationSize=i.animationSize,this.engine.animationStride=i.animationStride):(this.engine.animationSize=i.animationFrames,this.engine.animationStride=0);else if("svd"===i.animationEngine)if(this.engine.fps=i.stableVideoFps,this.engine.animationEngine="svd",this.engine.stableVideoModel=i.stableVideoModel,this.engine.motionBucketId=i.stableVideoMotionBucketId,this.engine.noiseAugStrength=i.stableVideoNoiseAugStrength,this.engine.minGuidanceScale=i.stableVideoMinGuidanceScale,this.engine.maxGuidanceScale=i.stableVideoMaxGuidanceScale,i.stableVideoReflect?this.engine.animationLoop="reflect":this.engine.animationLoop=null,i.stableVideoUseDrag){if(this.showMotionVectors(),"extend"===i.stableVideoMotionVectorRepeatMode){let i=Math.ceil(this.engine.animationFrames/14)-1;this.vector.setCopies(i),this.engine.motionVectors=this.getOffsetVectors(this.vector.extendedValue)}else this.vector.setCopies(0),this.engine.motionVectors=this.getOffsetVectors(this.vector.value),this.engine.repeatMotionVectors="repeat"===i.stableVideoMotionVectorRepeatMode;this.engine.gaussianSigma=i.stableVideoGaussianSigma}else this.hideMotionVectors()}else this.hideMotionVectors(),this.engine.animationFrames=0})),this.subscribe("engineAnimationEngineChange",(i=>{setTimeout((()=>{"svd"===i&&16===this.engine.animationFrames?this.animationForm.setValues({...this.animationForm.values,animationFrames:14}):"ad_hsxl"===i&&14===this.engine.animationFrames&&this.animationForm.setValues({...this.animationForm.values,animationFrames:16})}),125)})),this.subscribe("engineWidthChange",(i=>{this.resize(i,null)})),this.subscribe("engineHeightChange",(i=>{this.resize(null,i)})),this.subscribe("engineAnimationFramesChange",(i=>{if(this.animationForm.values.stableVideoRepeatVectors){let t=Math.ceil(i/14)-1;this.vector.setCopies(t)}})),this.subscribe("keyboard",(i=>{"c"==i.key&&i.ctrlKey?this.vector.copySelected():"z"==i.key&&i.ctrlKey?this.vector.undo():"y"===i.key&&i.ctrlKey?this.vector.redo():"Delete"==i.key&&this.vector.deleteSelected()})),this.vectorToolbar=new ToolbarView(this.config),this.vectorToolbar.addClass("motion-vectors"),this.vectorToolbar.hide(),await this.prepareMenu(this.vectorToolbar),this.application.container.appendChild(await this.vectorToolbar.render()),(await this.canvas.getNode()).find("enfugue-image-editor-overlay").append(await this.vector.getNode())}}export{AnimationController as SidebarController};
