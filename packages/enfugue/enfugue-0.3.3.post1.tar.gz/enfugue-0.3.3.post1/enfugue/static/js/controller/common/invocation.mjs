import{ImageInspectorView}from"../../view/image.mjs";import{isEmpty,isEquivalent,waitFor,humanDuration}from"../../base/helpers.mjs";import{ElementBuilder}from"../../base/builder.mjs";import{Controller}from"../base.mjs";const E=new ElementBuilder({invocationTask:"enfugue-invocation-task",invocationLoading:"enfugue-invocation-loading",invocationLoaded:"enfugue-invocation-loaded",invocationDuration:"enfugue-invocation-duration",invocationIterations:"enfugue-invocation-iterations",invocationRemaining:"enfugue-invocation-remaining",engineStop:"enfugue-engine-stop"});class InvocationController extends Controller{static truncatePromptLength=36;constructor(e){super(e),this.kwargs={},this.realTime=!1}publish(){let e=Array.from(arguments);super.publish(...e),this.debounceRealtimeInvoke()}debounceRealtimeInvoke(){this.realTime&&this.debounceInvoke()}debounceInvoke(){clearTimeout(this.invokeTimeout),this.invokeTimeout=setTimeout((()=>{super.publish("tryInvoke")}),100)}get width(){return this.kwargs.width||this.application.config.model.invocation.width}set width(e){this.width!==e&&this.publish("engineWidthChange",e),this.kwargs.width=e}get height(){return this.kwargs.height||this.application.config.model.invocation.height}set height(e){this.height!==e&&this.publish("engineHeightChange",e),this.kwargs.height=e}get tilingUnet(){return this.kwargs.tiling_unet||!1}set tilingUnet(e){this.tilingUnet!==e&&this.publish("engineTilingUnetChange",e),this.kwargs.tiling_unet=e}get tilingVae(){return this.kwargs.tiling_vae||!1}set tilingVae(e){this.tilingVae!==e&&this.publish("engineTilingVaeChange",e),this.kwargs.tiling_vae=e}get tilingSize(){return this.kwargs.tiling_size||null}set tilingSize(e){this.tilingSize!==e&&this.publish("engineTilingSizeChange",e),this.kwargs.tiling_size=e}get tilingStride(){return this.kwargs.tiling_stride||this.application.config.model.invocation.tilingStride}set tilingStride(e){this.tilingStride!==e&&this.publish("engineTilingStrideChange",e),this.kwargs.tiling_stride=e}get tilingMaskType(){return this.kwargs.tiling_mask_type||null}set tilingMaskType(e){this.tilingMaskType!==e&&this.publish("engineTilingMaskTypeChange",e),this.kwargs.tiling_mask_type=e}get prompt(){return this.kwargs.prompt||""}get prompt2(){return this.kwargs.prompt_2||""}set prompt(e){let t,i;Array.isArray(e)?[t,i]=e:t=e,this.prompt!==t&&this.publish("enginePromptChange",t),this.prompt2!==i&&this.publish("enginePrompt2Change",i),this.kwargs.prompt=t,this.kwargs.prompt_2=i}get negativePrompt(){return this.kwargs.negative_prompt||""}get negativePrompt2(){return this.kwargs.negative_prompt_2||""}set negativePrompt(e){let t,i;Array.isArray(e)?[t,i]=e:t=e,this.negativePrompt!==t&&this.publish("engineNegativePromptChange",t),this.negativePrompt2!==i&&this.publish("engineNegativePrompt2Change",i),this.kwargs.negative_prompt=t,this.kwargs.negative_prompt_2=i}get prompts(){return this.kwargs.prompts||[]}set prompts(e){isEmpty(e)&&(e=[]),e=e.map((e=>{let t={start:e.start,end:e.end,weight:e.weight};return Array.isArray(e.positive)?(t.positive=e.positive[0],t.positive_2=e.positive[1]):t.positive=e.positive,Array.isArray(e.negative)?(t.negative=e.negative[0],t.negative_2=e.negative[1]):t.negative=e.negative,t})),isEquivalent(this.prompts,e)||this.publish("enginePrompsChange",e),this.kwargs.prompts=e}get samples(){return this.kwargs.samples||1}set samples(e){this.samples!==e&&this.publish("engineSamplesChange",e),this.kwargs.samples=e}get iterations(){return this.kwargs.iterations||1}set iterations(e){this.iterations!==e&&this.publish("engineIterationsChange",e),this.kwargs.iterations=e}get seed(){return this.kwargs.seed}set seed(e){this.seed!==e&&this.publish("engineSeedChange",e),this.kwargs.seed=e}get guidanceScale(){return this.kwargs.guidance_scale||this.application.config.model.invocation.guidanceScale}set guidanceScale(e){this.guidanceScale!==e&&this.publish("engineGuidanceScaleChange",e),this.kwargs.guidance_scale=e}get inferenceSteps(){return this.kwargs.num_inference_steps||this.application.config.model.invocation.inferenceSteps}set inferenceSteps(e){this.inferenceSteps!==e&&this.publish("engineInferenceStepsChange",e),this.kwargs.num_inference_steps=e}get strength(){return this.kwargs.strength||1}set strength(e){this.strength!==e&&this.publish("engineStrengthChange",e),this.kwargs.strength=e}get mask(){return this.kwargs.mask||null}set mask(e){this.publish("engineMaskChange",e),this.kwargs.mask=e}set inferenceSteps(e){this.inferenceSteps!==e&&this.publish("engineInferenceStepsChange",e),this.kwargs.num_inference_steps=e}get model(){return this.kwargs.model}set model(e){this.model!==e&&this.publish("engineModelChange",e),this.kwargs.model=e}get modelType(){return this.kwargs.model_type||"checkpoint"}set modelType(e){this.modelType!==e&&this.publish("engineModelTypeChange",e),this.kwargs.model_type=e}get upscaleSteps(){return this.kwargs.upscale||null}get ipAdapterModel(){return this.kwargs.ip_adapter_model||null}set ipAdapterModel(e){this.ipAdapterModel!==e&&this.publish("engineIpAdapterModelChange",e),this.kwargs.ip_adapter_model=e}set upscaleSteps(e){let t=[];for(let i of e){let e={};isEmpty(i.prompt)||(Array.isArray(i.prompt)?(e.prompt=i.prompt[0],e.prompt_2=i.prompt[1]):e.prompt=i.prompt),isEmpty(i.negativePrompt)||(Array.isArray(i.negativePrompt)?(e.negative_prompt=i.negativePrompt[0],e.negative_prompt_2=i.negativePrompt[1]):e.negative_prompt=i.negativePrompt);for(let t of["strength","method","amount","scheduler"])isEmpty(i[t])||(e[t]=i[t]);isEmpty(i.inferenceSteps)||(e.num_inference_steps=i.inferenceSteps),isEmpty(i.guidanceScale)||(e.guidance_scale=i.guidanceScale),isEmpty(i.tilingUnet)||(e.tiling_unet=i.tilingUnet),isEmpty(i.tilingVae)||(e.tiling_vae=i.tilingVae),isEmpty(i.tilingStride)||(e.tiling_stride=i.tilingStride),isEmpty(i.tilingMaskType)||(e.tiling_mask_type=i.tilingMaskType),isEmpty(i.animationSize)||(e.frame_window_size=i.animationSize),isEmpty(i.animationStride)||(e.frame_window_stride=i.animationStride),isEmpty(i.controlnet)||(e.controlnet=i.controlnet),isEmpty(i.controlnetScale)||(e.controlnet_scale=i.controlnetScale),isEmpty(i.pipeline)||(e.refiner="base"!==i.pipeline),isEmpty(i.noiseOffset)||(e.noise_offset=i.noiseOffset),isEmpty(i.noiseMethod)||(e.noise_method=i.noiseMethod),isEmpty(i.noiseBlendMethod)||(e.noise_blend_method=i.noiseBlendMethod),t.push(e)}isEquivalent(this.upscaleSteps,t)||this.publish("engineUpscaleStepsChange",t),this.kwargs.upscale=t}get inversion(){return this.kwargs.inversion||[]}set inversion(e){isEquivalent(this.inversion,e)||this.publish("engineInversionChange",e),this.kwargs.inversion=e}get lora(){return this.kwargs.lora||[]}set lora(e){isEquivalent(this.lora,e)||this.publish("engineLoraChange",e),this.kwargs.lora=e}get lycoris(){return this.kwargs.lycoris||[]}set lycoris(e){isEquivalent(this.lycoris,e)||this.publish("engineLycorisChange",e),this.kwargs.lycoris=e}get refiner(){return this.kwargs.refiner||null}set refiner(e){this.refiner!==e&&this.publish("engineRefinerChange",e),this.kwargs.refiner=e}get refinerSize(){return this.kwargs.refiner_size||null}set refinerSize(e){this.refinerSize!==e&&this.publish("engineRefinerSizeChange",e),this.kwargs.refiner_size=e}get refinerVae(){return this.kwargs.refiner_vae||null}set refinerVae(e){this.refinerVae!==e&&this.publish("engineRefinerVaeChange",e),this.kwargs.refiner_vae=e}get refinerPrompt(){return this.kwargs.refiner_prompt||null}get refinerPrompt2(){return this.kwargs.refiner_prompt_2||null}set refinerPrompt(e){let t,i;Array.isArray(e)?[t,i]=e:t=e,this.refinerPrompt!==t&&this.publish("engineRefinerPromptChange",t),this.refinerPrompt2!==i&&this.publish("engineRefinerPrompt2Change",i),this.kwargs.refiner_prompt=t,this.kwargs.refiner_prompt_2=i}get refinerNegativePrompt(){return this.kwargs.refiner_negative_prompt||null}get refinerNegativePrompt2(){return this.kwargs.refiner_negative_prompt_2||null}set refinerNegativePrompt(e){let t,i;Array.isArray(e)?[t,i]=e:t=e,this.refinerNegativePrompt!==t&&this.publish("engineRefinerNegativePromptChange",t),this.refinerNegativePrompt2!==i&&this.publish("engineRefinerNegativePrompt2Change",i),this.kwargs.refiner_negative_prompt=t,this.kwargs.refiner_negative_prompt_2=i}get refinerStart(){return this.kwargs.refiner_start||.85}set refinerStart(e){this.refinerStart!==e&&this.publish("engineRefinerStartChange",e),this.kwargs.refiner_start=e}get refinerStrength(){return this.kwargs.refiner_strength||.3}set refinerStrength(e){this.refinerStrength!==e&&this.publish("engineRefinerStrengthChange",e),this.kwargs.refiner_strength=e}get refinerGuidanceScale(){return this.kwargs.refiner_guidance_scale||5}set refinerGuidanceScale(e){this.refinerGuidanceScale!==e&&this.publish("engineRefinerGuidanceScaleChange",e),this.kwargs.refiner_guidance_scale=e}get refinerAestheticScore(){return this.kwargs.refiner_aesthetic_score||6}set refinerAestheticScore(e){this.refinerAestheticScore!==e&&this.publish("engineAestheticScoreChange",e),this.kwargs.refiner_aesthetic_score=e}get refinerNegativeAestheticScore(){return this.kwargs.refiner_negative_aesthetic_score||2.5}set refinerNegativeAestheticScore(e){this.refinerNegativeAestheticScore!==e&&this.publish("engineNegativeAestheticScoreChange",e),this.kwargs.refiner_negative_aesthetic_score=e}get inpainter(){return this.kwargs.inpainter||null}set inpainter(e){this.inpainter!==e&&this.publish("engineInpainterChange",e),this.kwargs.inpainter=e}get inpainterVae(){return this.kwargs.inpainter_vae||null}set inpainterVae(e){this.inpainterVae!==e&&this.publish("engineInpainterVaeChange",e),this.kwargs.inpainter_vae=e}get scheduler(){return this.kwargs.scheduler||null}set scheduler(e){this.scheduler!==e&&this.publish("engineSchedulerChange",e),this.kwargs.scheduler=e}get betaStart(){return this.kwargs.scheduler_beta_start||null}set betaStart(e){this.betaStart!==e&&this.publish("engineSchedulerBetaStartChange",e),this.kwargs.scheduler_beta_start=e}get betaEnd(){return this.kwargs.scheduler_beta_end||null}set betaEnd(e){this.betaEnd!==e&&this.publish("engineSchedulerBetaEndChange",e),this.kwargs.scheduler_beta_end=e}get betaSchedule(){return this.kwargs.scheduler_beta_schedule||null}set betaSchedule(e){this.betaSchedule!==e&&this.publish("engineSchedulerBetaScheduleChange",e),this.kwargs.scheduler_beta_schedule=e}get vae(){return this.kwargs.vae||null}set vae(e){this.vae!==e&&this.publish("engineVaeChange",e),this.kwargs.vae=e}get motionModule(){return this.kwargs.motion_module||null}set motionModule(e){this.motionModule!==e&&this.publish("engineMotionModuleChange",e),this.kwargs.motion_module=e}get clipSkip(){return this.kwargs.clip_skip||null}set clipSkip(e){this.clipSkip!==e&&this.publish("engineClipSkipChange"),this.kwargs.clip_skip=e}get freeUFactors(){return this.kwargs.freeu_factors||null}set freeUFactors(e){isEquivalent(this.freeUFactors,e)||this.publish("engineFreeUFactorsChange"),this.kwargs.freeu_factors=e}get injectDpo(){return this.kwargs.inject_dpo||null}set injectDpo(e){this.injectDpo!==e&&this.publish("engineInjectDpoChange"),this.kwargs.inject_dpo=e}get noiseOffset(){return this.kwargs.noise_offset||0}set noiseOffset(e){this.noiseOffset!==e&&this.publish("engineNoiseOffsetChange"),this.kwargs.noise_offset=e}get noiseMethod(){return this.kwargs.noise_method||"perlin"}set noiseMethod(e){this.noiseMethod!==e&&this.publish("engineNoiseMethodChange"),this.kwargs.noise_method=e}get noiseBlendMethod(){return this.kwargs.noise_blend_method||"inject"}set noiseBlendMethod(e){this.noiseBlendMethod!==e&&this.publish("engineNoiseBlendMethodChange"),this.kwargs.noise_blend_method=e}get animationFrames(){return this.kwargs.animation_frames||null}set animationFrames(e){this.animationFrames!==e&&this.publish("engineAnimationFramesChange",e),this.kwargs.animation_frames=e}get animationSize(){return this.kwargs.frame_window_size||null}set animationSize(e){this.animationSize!==e&&this.publish("engineAnimationSizeChange",e),this.kwargs.frame_window_size=e}get animationStride(){return this.kwargs.frame_window_stride||null}set animationStride(e){this.animationStride!==e&&this.publish("engineAnimationStrideChange",e),this.kwargs.frame_window_stride=e}get animationLoop(){return this.kwargs.loop||null}set animationLoop(e){this.animationLoop!==e&&this.publish("engineAnimationLoopChange",e),this.kwargs.loop=e}get animationMotionScale(){return this.kwargs.motion_scale||null}set animationMotionScale(e){this.animationMotionScale!==e&&this.publish("engineAnimationMotionScaleChange",e),this.kwargs.motion_scale=e}get animationPositionEncodingTruncateLength(){return this.kwargs.position_encoding_truncate_length||null}set animationPositionEncodingTruncateLength(e){this.animationPositionEncodingTruncateLength!==e&&this.publish("engineAnimationPositionEncodingTruncateLengthChange",e),this.kwargs.position_encoding_truncate_length=e}get animationPositionEncodingScaleLength(){return this.kwargs.position_encoding_scale_length||null}set animationPositionEncodingScaleLength(e){this.animationPositionEncodingScaleLength!==e&&this.publish("engineAnimationPositionEncodingScaleLengthChange",e),this.kwargs.position_encoding_scale_length=e}get animationInterpolation(){return this.kwargs.interpolate_frames||null}set animationInterpolation(e){this.animationInterpolation!==e&&this.publish("engineAnimationInterpolationChange",e),this.kwargs.interpolate_frames=e}get animationDecodeChunkSize(){return this.kwargs.frame_decode_chunk_size||1}set animationDecodeChunkSize(e){isEquivalent(this.animationDecodeChunkSize,e)||this.publish("engineAnimationDecodeChunkSizeChange",e),this.kwargs.frame_decode_chunk_size=e}get animationDenoisingIterations(){return this.kwargs.num_denoising_iterations||1}set animationDenoisingIterations(e){isEquivalent(this.animationDenoisingIterations,e)||this.publish("engineAnimationDenoisingIterationsChange",e),this.kwargs.num_denoising_iterations=e}get animationRate(){return this.kwargs.frame_rate||8}set animationRate(e){isEquivalent(this.animationRate,e)||this.publish("engineAnimationRateChange",e),this.kwargs.frame_rate=e}get tileHorizontal(){let e=this.kwargs.tile;return!isEmpty(e)&&e[0]}set tileHorizontal(e){e!==this.tileHorizontal&&this.publish("engineTileHorizontalChange",e),this.kwargs.tile=[e,this.tileVertical]}get tileVertical(){let e=this.kwargs.tile;return!isEmpty(e)&&e[1]}set tileVertical(e){e!==this.tileVertical&&this.publish("engineTileVerticalChange",e),this.kwargs.tile=[this.tileHorizontal,e]}get outpaint(){return!!isEmpty(this.kwargs.outpaint)||this.kwargs.outpaint}set outpaint(e){this.outpaint!==e&&this.publish("engineOutpaintChange",e),this.kwargs.outpaint=e}get cropInpaint(){return!!isEmpty(this.kwargs.crop_inpaint)||this.kwargs.crop_inpaint}set cropInpaint(e){this.cropInpaint!==e&&this.publish("engineCropInpaintChange",e),this.kwargs.crop_inpaint=e}get inpaintFeather(){return this.kwargs.inpaint_feather||32}set inpaintFeather(e){this.inpaintFeather!==e&&this.publish("engineInpaintFeatherChange",e),this.kwargs.inpaint_feather=e}get detailerFaceRestore(){return!0===this.kwargs.detailer_face_restore}set detailerFaceRestore(e){this.detailerFaceRestore!==e&&this.publish("engineDetailerFaceRestoreChange"),this.kwargs.detailer_face_restore=e}get detailerFaceInpaint(){return!0===this.kwargs.detailer_face_inpaint}set detailerFaceInpaint(e){this.detailerFaceInpaint!==e&&this.publish("engineDetailerFaceInpaintChange"),this.kwargs.detailer_face_inpaint=e}get detailerHandInpaint(){return!0===this.kwargs.detailer_hand_inpaint}set detailerHandInpaint(e){this.detailerHandInpaint!==e&&this.publish("engineDetailerHandInpaintChange"),this.kwargs.detailer_hand_inpaint=e}get detailerInpaintStrength(){return!0===this.kwargs.detailer_inpaint_strength}set detailerInpaintStrength(e){this.detailerInpaintStrength!==e&&this.publish("engineDetailerInpaintStrengthChange"),this.kwargs.detailer_inpaint_strength=e}get detailerStrength(){return this.kwargs.detailer_denoising_strength||null}set detailerStrength(e){this.detailerStrength!==e&&this.publish("engineDetailerStrengthChange"),this.kwargs.detailer_denoising_strength=e}get detailerGuidanceScale(){return this.kwargs.detailer_guidance_scale||null}set detailerGuidanceScale(e){this.detailerGuidanceScale!==e&&this.publish("engineDetailerGuidanceScaleChange"),this.kwargs.detailer_guidance_scale=e}get detailerInferenceSteps(){return this.kwargs.detailer_inference_steps||null}set detailerInferenceSteps(e){this.detailerInferenceSteps!==e&&this.publish("engineDetailerInferenceStepsChange"),this.kwargs.detailer_inference_steps=e}get detailerControlnet(){return this.kwargs.detailer_controlnet||null}set detailerControlnet(e){this.detailerControlnet!==e&&this.publish("engineDetailerControlnetChange"),this.kwargs.detailer_controlnet=e}get detailerControlnetScale(){return this.kwargs.detailer_controlnet_scale||null}set detailerControlnetScale(e){this.detailerControlnetScale!==e&&this.publish("engineDetailerControlnetScaleChange"),this.kwargs.detailer_controlnet_scale=e}get animationEngine(){return this.kwargs.animation_engine||"ad_hsxl"}set animationEngine(e){this.animationEngine!==e&&this.publish("engineAnimationEngineChange",e),this.kwargs.animation_engine=e}get motionBucketId(){return this.kwargs.motion_bucket_id||null}set motionBucketId(e){this.motionBucketId!==e&&this.publish("engineMotionBucketIdChange",e),this.kwargs.motion_bucket_id=e}get fps(){return this.kwargs.fps||null}set fps(e){this.fps!==e&&this.publish("engineFpsChange",e),this.kwargs.fps=e}get noiseAugStrength(){return this.kwargs.noise_aug_strength||null}set noiseAugStrength(e){this.noise_aug_strength!==e&&this.publish("engineNoiseAugStrengthChange",e),this.kwargs.noise_aug_strength=e}get maxGuidanceScale(){return this.kwargs.max_guidance_scale||null}set maxGuidanceScale(e){this.max_guidance_scale!==e&&this.publish("engineMaxGuidanceScaleChange",e),this.kwargs.max_guidance_scale=e}get minGuidanceScale(){return this.kwargs.min_guidance_scale||null}set minGuidanceScale(e){this.min_guidance_scale!==e&&this.publish("engineMinGuidanceScaleChange",e),this.kwargs.min_guidance_scale=e}get motionVectors(){return this.kwargs.motion_vectors||null}set motionVectors(e){isEquivalent(this.motionVectors,e)||this.publish("engineMotionVectorsChange",e),this.kwargs.motion_vectors=e}get gaussianSigma(){return this.kwargs.gaussian_sigma||20}set gaussianSigma(e){isEquivalent(this.gaussianSigma,e)||this.publish("engineGaussianSigmaChange",e),this.kwargs.gaussian_sigma=e}get stableVideoModel(){return this.kwargs.svd_model}set stableVideoModel(e){this.stableVideoModel!==e&&this.publish("engineStableVideoModelChange",e),this.kwargs.svd_model=e}get repeatMotionVectors(){return this.kwargs.motion_vector_repeat_window||!1}set repeatMotionVectors(e){this.repeatMotionVectors!==e&&this.publish("engineStableVideoModelChange",e),this.kwargs.motion_vector_repeat_window=e}async initialize(){this.loadingBar=E.invocationLoading().content(E.invocationLoaded().addClass("sliding-gradient"),E.invocationDuration(),E.invocationIterations(),E.invocationTask().hide(),E.invocationRemaining().hide()),this.engineStop=E.engineStop().content("Stop Engine").on("click",(()=>{this.stopEngine()})),this.application.container.appendChild(await this.engineStop.render()),this.application.container.appendChild(await this.loadingBar.render()),this.subscribe("engineReady",(()=>{this.enableStop()})),this.subscribe("engineBusy",(()=>{this.enableStop()})),this.subscribe("engineIdle",(()=>{this.disableStop()})),this.subscribe("layersChanged",(()=>{this.debounceRealtimeInvoke()}))}enableStop(){this.engineStop.addClass("ready")}disableStop(){this.engineStop.removeClass("ready")}async invoke(e,t=!1){e=isEmpty(e)?{}:e;let i={...this.kwargs,...e};for(let e of Object.getOwnPropertyNames(i))"number"==typeof i[e]&&isNaN(i[e])&&delete i[e];this.realTime&&(i.synchronous=!0),this.config.debug&&console.log("Invoking with payload",i);let n=await this.application.model.post("invoke",null,null,i);if(this.enableStop(),!isEmpty(n.uuid))if(t){let e=i.prompt.substring(0,this.constructor.truncatePromptLength);e.length===this.constructor.truncatePromptLength&&(e+="..."),await this.startDetachedInvocationMonitor(e,n.uuid,parseInt(i.width)||512,parseInt(i.height)||512)}else this.startSample=!0,this.application.samples.resetSampleChooser(),await this.canvasInvocation(n.uuid,n.animation)}async stopEngine(){if(this.engineStop.hasClass("ready")&&await this.confirm("Stop engine and terminate any active invocations?"))try{await this.application.model.post("/invocation/stop"),this.disableStop(),this.notify("info","Stopped","Successfully stopped engine.")}catch(e){let t=`${e}`;isEmpty(e.detail)?isEmpty(e.title)||(t=e.title):t=e.detail,this.notify("error","Error",`Received an error when stopping. The engine may still be stopped, wait a moment and check again. ${t}`)}}setSampleImages(e,t=!1){this.application.samples.setSamples(e,t),this.startSample&&(t?(this.application.samples.setLoop(!0),this.application.samples.setPlay(!0)):this.application.samples.setActive(0),this.startSample=!1)}setSampleVideo(e){this.application.samples.setVideo(e)}async monitorInvocation(e,t,i,n,s,a){const r=this.application.config.model.invocation.interval||1e3,o=this.application.config.model.queue.interval||5e3,h=this.application.config.model.invocation.errors.consecutive||2;void 0===i&&(i=()=>{}),void 0===t&&(t=()=>{}),void 0===s&&(s=()=>{}),void 0===a&&(a=()=>{}),void 0===n&&(n=()=>{});let g,l,p,u,c,d,m,w=(new Date).getTime(),_=async()=>{let k,f;for(let t=0;t<h;t++)try{k=await this.application.model.get(`/invocation/${e}`)}catch(e){f=e}if(isEmpty(k))return this.notify("error","Invocation Error",`${h} consecutive errors were detected communicating with the server. Please check the server logs. The last error was: ${f}`),void s();if(k.total!==p&&(isEmpty(p)||(w=(new Date).getTime()),p=k.total),k.step!==l&&(l=k.step,d=(new Date).getTime()),k.rate!==u&&(u=k.rate),k.task!==g&&(t(k.task),g=k.task),c=k.duration,!isEmpty(k.images)){let e=k.images.map((e=>`/api/invocation/${e}`)),t="completed"===k.status;i(e,t)}if(!isEmpty(k.video)){let e=`/api/invocation/${k.video}`;n(e)}if("error"===k.status)return this.notify("error","Invocation Failed",k.message),void s();if("completed"!==k.status){let e=l/(d-w),t=isEmpty(u)?e:u/1e3,i=(p-l)/(.75*t+.25*e)-((new Date).getTime()-d);isNaN(i)&&(i=1/0),a(i,l,p,u,c),m=setTimeout(_,(e=>"queued"===e.status?o:r)(k))}};_()}async canvasInvocation(e,t=!1){let i,n,s,a,r,o,h,g,l,p,u,c=!1,d=!1,m=(new Date).getTime(),w=m,_=m,k=m,f=this.loadingBar.find(E.getCustomTag("invocationTask")),v=this.loadingBar.find(E.getCustomTag("invocationLoaded")),S=this.loadingBar.find(E.getCustomTag("invocationDuration")),b=this.loadingBar.find(E.getCustomTag("invocationIterations")),C=this.loadingBar.find(E.getCustomTag("invocationRemaining")),y=()=>this.setSampleImages(o,t),I=()=>{let e=(new Date).getTime();if(d)a<100&&a>0?a+=1:(a=100,c=!0);else if(!isEmpty(n)&&n<1/0){let t=e-_,o=n-(e-s),h=t+o;r=o,i=h,a=t/h*100}w=e,(()=>{let e=w-m;if(S.content(humanDuration(e/1e3)),isEmpty(a))v.css("width","100%"),b.hide(),C.show().content("Initializing…");else if(a<100){C.show().content(humanDuration(r/1e3)),v.css("width",`${a.toFixed(2)}%`);let e=l,t="it/s";!isEmpty(e)&&e<1/0&&0!==e?(e<1&&(e=1/e,t="s/it"),b.show().content(`Iteration ${h}/${g} (${e.toFixed(2)} ${t})`)):b.show().content(`Iteration ${h}/${g}`)}else if(c||isEmpty(p))v.css("width","0"),C.empty().hide();else{C.content("Finalizing step…");let e=g/p,t="it/s";e<1&&(e=1/e,t="s/it"),b.content(`${g} Iterations at ${e.toFixed(2)} ${t}`),v.css("width","100%")}})(),c||requestAnimationFrame((()=>I()))};this.loadingBar.addClass("loading"),window.requestAnimationFrame((()=>I())),this.monitorInvocation(e,(e=>{u=e,isEmpty(e)?f.empty().hide():f.content(e).show()}),(async(e,t)=>{d=t,e.length>0&&(o=e,y())}),(async e=>{this.setSampleVideo(e)}),(()=>{d=!0,c=!0,C.empty().hide(),b.empty().hide(),f.empty().hide()}),((e,t,i,r,o)=>{n=e,h!==t&&(k=s),h=t,l=r,p=o,s=(new Date).getTime(),g!==i&&(_=s,isEmpty(g)||(h=0,a=null,k=s)),g=i})),await waitFor((()=>c)),f.empty().hide(),this.loadingBar.removeClass("loading")}async startDetachedInvocationMonitor(e,t,i,n){let s=!1,a=[],r=[];this.monitorInvocation(t,(async(o,h,g)=>{s=!0;for(let s in o){let h=o[s];if(a.length<=s){let o=new ImageInspectorView(this.application.config,h,t),g=await this.spawnWindow(`${e}, sample ${s+1}`,o,i+30,n+90);o.loading(),a.push(g),r.push(o)}else r[s].setImage(h),a[s].setName(`${e}, ${g} elapsed, sample ${s+1}`)}if(h)for(let t in a)a[t].setName(`${e} complete in ${g}, sample ${t+1}`),r[t].doneLoading()}),(()=>s=!0)),await waitFor((()=>!0===s))}}export{InvocationController};
