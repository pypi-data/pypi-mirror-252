import{isEmpty,levenshtein,strip,stripHTML}from"../../base/helpers.mjs";import{ElementBuilder}from"../../base/builder.mjs";import{InputView}from"./base.mjs";import{StringInputView}from"./string.mjs";const E=new ElementBuilder({searchList:"enfugue-search-list",searchListItem:"enfugue-search-list-item",searchSelection:"enfugue-search-list-selection",repeatableInput:"enfugue-repeatable-input",repeatableItem:"enfugue-repeatable-input-item"});class EnumerableInputView extends InputView{static defaultOptions={};constructor(t,e,s){super(t,e,s),this.options=this.fieldConfig.options||{},this.sortFunction=this.fieldConfig.sortFunction||((t,e)=>t-e),this.filterFunction=this.fieldConfig.filterFunction||((t,e)=>!1)}setOptions(t){Array.isArray(t)?this.options=t.reduce(((t,e)=>(t[e]=e,t)),{}):this.options=t,void 0!==this.node&&this.rebuildOptions()}async sortOptions(t){this.sortFunction=t,void 0!==this.node&&await this.rebuildOptions()}async filterOptions(t){this.filterFunction=t,void 0!==this.node&&await this.rebuildOptions()}async sortFilterOptions(t,e){this.sortFunction=t,this.filterFunction=e,void 0!==this.node&&await this.rebuildOptions()}async getOptions(){let t=this.options,e=this.constructor.defaultOptions;"function"==typeof t&&(t=await this.options()),Array.isArray(t)&&(t=t.reduce(((t,e)=>(t[e]=e,t)),{})),"function"==typeof e&&(e=await e()),Array.isArray(e)&&(e=e.reduce(((t,e)=>(t[e]=e,t)),{}));let s={...e,...t},i=Object.getOwnPropertyNames(s),n={};i.sort(((t,e)=>this.sortFunction(t,e,s[t],s[e])));for(let t of i)this.filterFunction(t,s[t])||(n[t]=s[t]);return n}buildOptions(t,e){}async rebuildOptions(){void 0!==this.node&&this.buildOptions(this.node,await this.getOptions())}async build(){let t=await super.build();return this.buildOptions(t,await this.getOptions()),t}}class SelectInputView extends EnumerableInputView{static tagName="select";static alwaysShowEmpty=!1;static allowEmpty=!1;async buildOptions(t,e){let s=this.placeholder;isEmpty(s)&&(s="Select One");let i=[];(isEmpty(this.value)||this.constructor.alwaysShowEmpty||this.constructor.allowEmpty)&&i.push(E.option().selected(!0).disabled(!this.constructor.allowEmpty).value("").content(s));for(let t in e){let s=E.option().value(t).content(e[t]);this.value==t&&s.selected(!0),i.push(s)}return t.content(...i)}setValue(t,e){void 0!==this.node&&void 0!==this.node.element&&(this.node.element.value=t,requestAnimationFrame((()=>{let e;for(let s of this.node.findAll("option"))isEmpty(s.value())&&isEmpty(t)||s.value()==t?e=s:s.selected(!1);isEmpty(e)||(e.selected(!0),requestAnimationFrame((()=>{e.element.selected="selected"})))}))),super.setValue(t,e)}async build(){let t=await super.build();return isEmpty(this.value)||t.value(this.value),t}}class ListInputView extends EnumerableInputView{static tagName="ul";static className="list-input-view";static maximumOptions=1/0;getValue(){return this.value}setValue(t,e){if(super.setValue(t,e),void 0!==this.node)for(let t of this.node.findAll("li"))t.data("value")===this.value?t.addClass("selected"):t.removeClass("selected")}buildOptions(t,e){let s=0,i=[];for(let n in e){let a=E.span().content(e[n]),l=E.li().content(a).data("value",n);if(l.on("click",(e=>{e.stopPropagation(),e.preventDefault();for(let e of t.children())e.removeClass("selected");l.addClass("selected"),this.value=n,this.changed()})),this.value==n&&l.addClass("selected"),i.push(l),s++,s>=this.constructor.maximumOptions)break}return t.content(...i)}}class ListMultiInputView extends ListInputView{static maximumSelected=1/0;static className="list-input-view multi-list-input-view";constructor(t,e,s){super(t,e,s),isEmpty(this.value)&&(this.value=[])}setValue(t,e){if(super.setValue(t,e),isEmpty(this.value)?this.value=[]:Array.isArray(this.value)||(this.value=[this.value]),void 0!==this.node)for(let t of this.node.findAll("li"))-1!==this.value.indexOf(t.data("value"))?t.addClass("selected"):t.removeClass("selected")}buildOptions(t,e){let s=0,i=[];for(let t in e){let n=E.li().content(E.span().content(e[t])).data("value",t);if(n.on("click",(e=>{e.stopPropagation(),e.preventDefault(),n.hasClass("selected")?(this.value=this.value.filter((e=>e!==t)),n.removeClass("selected")):(isEmpty(this.value)&&(this.value=[]),this.value.push(t),n.addClass("selected")),this.changed()})),isEmpty(this.value)&&-1!==this.value.indexOf(t)&&n.addClass("selected"),i.push(n),s++,s>=this.constructor.maximumOptions)break}return t.content(...i)}}class SearchListInputListView extends ListInputView{static maximumOptions=100;static classList=["enfugue-search-list-items"];async build(){let t=await super.build();return t.on("mousewheel",(t=>{t.stopPropagation()})),t}}class SearchListMultiInputListView extends ListMultiInputView{static maximumOptions=100;static classList=["enfugue-search-list-items","enfugue-multi-search-list-items"];async build(){let t=await super.build();return t.on("mousewheel,mouseup",(t=>{t.stopPropagation()})),t}}class SearchListInputView extends EnumerableInputView{static tagName="enfugue-search-list";static placeholder="Start typing to searchâ€¦";static searchTimeout=250;static filterThreshold=.9;static listInputClass=SearchListInputListView;static stringInputClass=StringInputView;static allowNewValues=!1;static setClosestOnBlur=!0;static resetListOnFocus=!0;static hideListOnBlur=!0;static hideListOnChange=!0;static populateSearchOnSet=!0;static debounceChangeThreshold=150;constructor(t,e,s){super(t,e,s),this.stringInput=new this.constructor.stringInputClass(t,"autofill",{placeholder:this.constructor.placeholder}),this.stringInput.onInput((t=>this.searchChanged(t))),this.stringInput.onFocus((async()=>{await this.search(await this.stringInput.getValue());await this.stringInput.getNode();let t=await this.listInput.getNode(),e=this.node.element.getBoundingClientRect(),s=e.x,i=e.y+e.height,n=e.width,a=(e,a,l)=>{s=e,i=a,n=l,t.css({width:`${l}px`,left:`${e}px`,top:`${a}px`})};this.repositionInterval=setInterval((()=>{e=this.node.element.getBoundingClientRect();let t=e.x,l=e.y+e.height,o=e.width;s===t&&i===l&&n===o||a(t,l,o)}),25),document.body.appendChild(t.render()),a(s,i,n),t.css({width:`${e.width}px`,left:`${e.x}px`,top:`${e.y+e.height}px`}),this.listInput.show(),this.constructor.resetListOnFocus&&this.listInput.setValue(null,!1);let l=t=>{this.listInput.hide(),window.removeEventListener("click",l,!1),clearTimeout(this.searchDebounceTimer),clearInterval(this.repositionInterval)};window.addEventListener("click",l,!1)})),this.stringInput.onBlur((async t=>{if(this.constructor.hideListOnBlur){if(this.listInputInput){let t=e=>{setTimeout((async()=>{this.listInput.hide(),document.body.removeChild((await this.listInput.getNode()).element)}),100),window.removeEventListener("mouseup",t,!0)};window.addEventListener("mouseup",t,!0)}else this.listInput.hide(),document.body.removeChild((await this.listInput.getNode()).element);clearTimeout(this.searchDebounceTimer),clearInterval(this.repositionInterval)}if(!0!==this.listInputInput)if(this.constructor.setClosestOnBlur){let t=strip(this.stringInput.getValue()).toLowerCase(),e=!1;if(isEmpty(t))e=!isEmpty(this.value),this.value=null;else{let s=await this.getOptions(),i=Object.getOwnPropertyNames(s),n=this.getSearchSortFunction(t);i.sort(((t,e)=>n(t,e,s[t],s[e]))),e=this.value!==i[0],this.value=i[0],this.stringInput.setValue(s[this.value],!1)}e&&this.changed()}else this.constructor.allowNewValues&&(this.value=this.stringInput.getValue(),this.changed())})),this.listInput=new this.constructor.listInputClass(t,"list",{options:()=>this.getOptions()}),this.listInput.onMouseDown((async()=>{this.listInputInput=!0})),this.listInput.onMouseUp((async()=>{this.listInputInput=!1})),this.listInput.onChange((async()=>{let t=await this.getOptions(),e=this.listInput.getValue();this.value=e,this.constructor.populateSearchOnSet&&this.stringInput.setValue(t[e],!1),this.constructor.hideListOnChange&&(clearTimeout(this.searchDebounceTimer),clearInterval(this.repositionInterval)),this.changed()})),this.listInput.hide()}disable(){if(clearTimeout(this.searchDebounceTimer),this.stringInput.disable(),this.listInput.disable(),void 0!==this.node)for(let t of this.node.findAll(E.getCustomTag("searchSelection")))t.find("button").disabled(!0)}enable(){if(this.stringInput.enable(),this.listInput.enable(),void 0!==this.node)for(let t of this.node.findAll(E.getCustomTag("searchSelection")))t.find("button").disabled(!1)}setOptions(t){super.setOptions(t),this.listInput.setValue([],!1),this.listInput.setOptions(t)}rebuildOptions(){}buildOptions(){}getValue(){return this.value}setValue(t,e){super.setValue(t,!1);void 0!==this.stringInput&&this.stringInput.setValue(t,!1),e&&this.changed()}searchChanged(t){clearTimeout(this.searchDebounceTimer),this.searchDebounceTimer=setTimeout((()=>{this.search(t)}),this.constructor.searchTimeout)}getSearchSortFunction(t){return t=t.toLowerCase(),(e,s,i,n)=>{let a=strip(stripHTML(i)).toLowerCase(),l=strip(stripHTML(n)).toLowerCase(),o=Math.min(a.length,l.length,t.length),u=t.substring(0,o);a=a.substring(0,o),l=l.substring(0,o);let r=levenshtein(a,u),h=levenshtein(l,u);return r===h?a.length-l.length:r-h}}async search(t){t=strip(t),isEmpty(t)?await this.listInput.sortOptions(((t,e)=>t-e)):await this.listInput.sortOptions(this.getSearchSortFunction(t))}async build(){let t=await super.build();return t.append(await this.stringInput.getNode()),t.on("dragover",(e=>{e.preventDefault(),e.stopPropagation();let s=e.target,i=t.findAll(E.getCustomTag("searchSelection")),n=e.offsetX;for(let t of i)t.removeClass("drop-left").removeClass("drop-right");for(;-1===["ENFUGUE-SEARCH-LIST-SELECTION","ENFUGUE-SEARCH-LIST"].indexOf(s.tagName);)n+=s.offsetLeft,s=s.parentElement;if("ENFUGUE-SEARCH-LIST-SELECTION"==s.tagName&&!s.classList.contains("dragged")){let t=s.dataset.selectValue,e=i.filter((e=>e.data("select-value")===t)).shift();n>s.offsetWidth/2?e.addClass("drop-right"):e.addClass("drop-left")}})).on("drop",(e=>{let s=e.target,i=e.dataTransfer.getData("text/plain"),n=e.offsetX,a=t.findAll(E.getCustomTag("searchSelection"));for(let t of a)t.removeClass("drop-left").removeClass("drop-right");for(;-1===["ENFUGUE-SEARCH-LIST-SELECTION","ENFUGUE-SEARCH-LIST"].indexOf(s.tagName);)n+=s.offsetLeft,s=s.parentElement;if("ENFUGUE-SEARCH-LIST-SELECTION"==s.tagName){let e=s.dataset.selectValue;if(i!==e){let l=a.filter((t=>t.data("select-value")===i)).shift(),o=a.filter((t=>t.data("select-value")===e)).shift(),u=this.value.indexOf(i),r=this.value.indexOf(e),h=(l.find("span").getText(),o.find("span").getText(),n>s.offsetWidth/2);t.remove(l),this.value=this.value.filter((t=>t!=i)),!h&&u<r?r--:h&&u>r&&r++,this.value=this.value.slice(0,r).concat([i]).concat(this.value.slice(r)),this.listInput.setValue(this.value,!1),t.insert(r,l),this.changed()}}})),t}async changed(t){let e=(new Date).getTime();void 0!==this.lastChange&&e-this.lastChange<this.constructor.debounceChangeThreshold||(await super.changed(t),this.lastChange=e)}}class SearchListMultiInputView extends SearchListInputView{static setClosestOnBlur=!1;static resetListOnFocus=!1;static hideListOnBlur=!1;static populateSearchOnSet=!1;static hideListOnChange=!1;static listInputClass=SearchListMultiInputListView;constructor(t,e,s){super(t,e,s),this.onChange((async()=>{let t=this.getValue(),e=await this.getOptions();isEmpty(t)&&(t=[]),void 0!==this.node&&this.node.content(...t.map((t=>{let s=E.searchSelection().data("select-value",t),i=E.button().content("&times;"),n=E.span().content(e[t]);return i.on("click",(t=>{t.preventDefault(),t.stopPropagation(),this.value=this.value.filter((t=>t!==s.data("select-value"))),this.listInput.setValue(this.value,!1),this.changed()})),s.attr("draggable","true").on("dragstart",(e=>{s.addClass("dragged");let i=e.dataTransfer;i.dropEffect="move",i.effectAllowed="move",i.setData("text/plain",t)})).on("dragend",(t=>{s.removeClass("dragged")})),s.content(i,n)})),await this.stringInput.getNode())}))}async build(){let t=await super.build();return t.append(await this.stringInput.getNode()),t}}export{EnumerableInputView,SelectInputView,ListInputView,ListMultiInputView,SearchListInputView,SearchListInputListView,SearchListMultiInputView};
